"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _resolver = _interopRequireDefault(require("./resolver"));

var _error = _interopRequireDefault(require("./error"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const validateNode = (node, definition, ctx) => {
  if (node && definition && definition.validators) {
    // TODO: enable this validation when completed with all allowed fields in validators
    const allowedChildren = [...Object.keys(definition.properties || {}), ...Object.keys(definition.validators || {})];
    Object.keys(node).forEach(field => {
      ctx.path.push(field);

      if (!allowedChildren.includes(field) && field.indexOf('x-') !== 0) {
        ctx.result.push((0, _error.default)('This field is not permitted here', node, ctx, 'key'));
      }

      ctx.path.pop();
    });
    Object.keys(definition.validators).forEach(v => {
      if (Object.keys(node).includes(v)) ctx.path.push(v);
      const validationResult = definition.validators[v]()(node, ctx);
      if (Object.keys(node).includes(v)) ctx.path.pop();
      if (validationResult) ctx.result.push(validationResult);
    });
  }
};

const traverseNode = (node, definition, ctx) => {
  const currentPath = ctx.path.join('/'); // TO-DO: refactor ctx.visited into dictionary for O(1) check time

  if (ctx.visited.includes(currentPath)) return;
  ctx.visited.push(currentPath);
  if (!node || !definition) return; // console.log(`Current path: ${currentPath}`);

  let nextPath;
  let prevPath;
  let resolvedNode; // eslint-disable-next-line prefer-const

  ({
    node: resolvedNode,
    nextPath
  } = (0, _resolver.default)(node, ctx));

  if (nextPath) {
    ctx.pathStack.push(ctx.path);
    prevPath = ctx.path;
    ctx.path = nextPath.replace('#/', '').split('/');
  }

  if (Array.isArray(resolvedNode)) {
    resolvedNode.forEach((nodeChild, i) => {
      ctx.path.push(i);
      traverseNode(nodeChild, definition, ctx);
      ctx.path.pop();
    });
    if (nextPath) ctx.path = prevPath;
    return;
  }

  validateNode(resolvedNode, definition, ctx);

  if (definition.properties) {
    let nodeChildres;

    switch (typeof definition.properties) {
      case 'function':
        nodeChildres = definition.properties(resolvedNode);
        Object.keys(nodeChildres).forEach(child => {
          if (Object.keys(resolvedNode).includes(child)) {
            ctx.path.push(child);
            if (resolvedNode[child]) traverseNode(resolvedNode[child], nodeChildres[child], ctx);
            ctx.path.pop();
          }
        });
        break;

      case 'object':
        Object.keys(definition.properties).forEach(p => {
          ctx.path.push(p);

          if (typeof definition.properties[p] === 'function') {
            if (resolvedNode[p]) traverseNode(resolvedNode[p], definition.properties[p](), ctx);
          } else if (node[p]) {
            traverseNode(resolvedNode[p], definition.properties[p], ctx);
          }

          ctx.path.pop();
        });
        break;

      default:
        break;
    }
  }

  if (nextPath) ctx.path = ctx.pathStack.pop();
};

const traverse = (node, definition, sourceFile) => {
  const ctx = {
    document: node,
    path: [],
    visited: [],
    result: [],
    pathStack: [],
    source: sourceFile // enableCodeframe: true,

  };
  traverseNode(node, definition, ctx);
  return ctx.result;
};

var _default = traverse;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmF2ZXJzZS5qcyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZU5vZGUiLCJub2RlIiwiZGVmaW5pdGlvbiIsImN0eCIsInZhbGlkYXRvcnMiLCJhbGxvd2VkQ2hpbGRyZW4iLCJPYmplY3QiLCJrZXlzIiwicHJvcGVydGllcyIsImZvckVhY2giLCJmaWVsZCIsInBhdGgiLCJwdXNoIiwiaW5jbHVkZXMiLCJpbmRleE9mIiwicmVzdWx0IiwicG9wIiwidiIsInZhbGlkYXRpb25SZXN1bHQiLCJ0cmF2ZXJzZU5vZGUiLCJjdXJyZW50UGF0aCIsImpvaW4iLCJ2aXNpdGVkIiwibmV4dFBhdGgiLCJwcmV2UGF0aCIsInJlc29sdmVkTm9kZSIsInBhdGhTdGFjayIsInJlcGxhY2UiLCJzcGxpdCIsIkFycmF5IiwiaXNBcnJheSIsIm5vZGVDaGlsZCIsImkiLCJub2RlQ2hpbGRyZXMiLCJjaGlsZCIsInAiLCJ0cmF2ZXJzZSIsInNvdXJjZUZpbGUiLCJkb2N1bWVudCIsInNvdXJjZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLENBQUNDLElBQUQsRUFBT0MsVUFBUCxFQUFtQkMsR0FBbkIsS0FBMkI7QUFDOUMsTUFBSUYsSUFBSSxJQUFJQyxVQUFSLElBQXNCQSxVQUFVLENBQUNFLFVBQXJDLEVBQWlEO0FBQy9DO0FBQ0EsVUFBTUMsZUFBZSxHQUFHLENBQ3RCLEdBQUlDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZTCxVQUFVLENBQUNNLFVBQVgsSUFBeUIsRUFBckMsQ0FEa0IsRUFFdEIsR0FBSUYsTUFBTSxDQUFDQyxJQUFQLENBQVlMLFVBQVUsQ0FBQ0UsVUFBWCxJQUF5QixFQUFyQyxDQUZrQixDQUF4QjtBQUlBRSxJQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWU4sSUFBWixFQUFrQlEsT0FBbEIsQ0FBMkJDLEtBQUQsSUFBVztBQUNuQ1AsTUFBQUEsR0FBRyxDQUFDUSxJQUFKLENBQVNDLElBQVQsQ0FB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RCxDQUFiLEVBQWtCakMsVUFBVSxDQUFDTSxVQUFYLENBQXNCMkIsQ0FBdEIsR0FBbEIsRUFBOENoQyxHQUE5QyxDQUFaO0FBQ3RCLFdBRkQsTUFFTyxJQUFJRixJQUFJLENBQUNrQyxDQUFELENBQVIsRUFBYTtBQUNsQmhCLFlBQUFBLFlBQVksQ0FBQ00sWUFBWSxDQUFDVSxDQUFELENBQWIsRUFBa0JqQyxVQUFVLENBQUNNLFVBQVgsQ0FBc0IyQixDQUF0QixDQUFsQixFQUE0Q2hDLEdBQTVDLENBQVo7QUFDRDs7QUFDREEsVUFBQUEsR0FBRyxDQUFDUSxJQUFKLENBQVNLLEdBQVQ7QUFDRCxTQVJEO0FBVUE7O0FBQ0Y7QUFDRTtBQTNCSjtBQTZCRDs7QUFDRCxNQUFJTyxRQUFKLEVBQWNwQixHQUFHLENBQUNRLElBQUosR0FBV1IsR0FBRyxDQUFDdUIsU0FBSixDQUFjVixHQUFkLEVBQVg7QUFDZixDQWxFRDs7QUFvRUEsTUFBTW9CLFFBQVEsR0FBRyxDQUFDbkMsSUFBRCxFQUFPQyxVQUFQLEVBQW1CbUMsVUFBbkIsS0FBa0M7QUFDakQsUUFBTWxDLEdBQUcsR0FBRztBQUNWbUMsSUFBQUEsUUFBUSxFQUFFckMsSUFEQTtBQUVWVSxJQUFBQSxJQUFJLEVBQUUsRUFGSTtBQUdWVyxJQUFBQSxPQUFPLEVBQUUsRUFIQztBQUlWUCxJQUFBQSxNQUFNLEVBQUUsRUFKRTtBQUtWVyxJQUFBQSxTQUFTLEVBQUUsRUFMRDtBQU1WYSxJQUFBQSxNQUFNLEVBQUVGLFVBTkUsQ0FPVjs7QUFQVSxHQUFaO0FBU0FsQixFQUFBQSxZQUFZLENBQUNsQixJQUFELEVBQU9DLFVBQVAsRUFBbUJDLEdBQW5CLENBQVo7QUFDQSxTQUFPQSxHQUFHLENBQUNZLE1BQVg7QUFDRCxDQVpEOztlQWNlcUIsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXNvbHZlTm9kZSBmcm9tICcuL3Jlc29sdmVyJztcbmltcG9ydCBjcmVhdGVFcnJvciBmcm9tICcuL2Vycm9yJztcblxuY29uc3QgdmFsaWRhdGVOb2RlID0gKG5vZGUsIGRlZmluaXRpb24sIGN0eCkgPT4ge1xuICBpZiAobm9kZSAmJiBkZWZpbml0aW9uICYmIGRlZmluaXRpb24udmFsaWRhdG9ycykge1xuICAgIC8vIFRPRE86IGVuYWJsZSB0aGlzIHZhbGlkYXRpb24gd2hlbiBjb21wbGV0ZWQgd2l0aCBhbGwgYWxsb3dlZCBmaWVsZHMgaW4gdmFsaWRhdG9yc1xuICAgIGNvbnN0IGFsbG93ZWRDaGlsZHJlbiA9IFtcbiAgICAgIC4uLihPYmplY3Qua2V5cyhkZWZpbml0aW9uLnByb3BlcnRpZXMgfHwge30pKSxcbiAgICAgIC4uLihPYmplY3Qua2V5cyhkZWZpbml0aW9uLnZhbGlkYXRvcnMgfHwge30pKSxcbiAgICBdO1xuICAgIE9iamVjdC5rZXlzKG5vZGUpLmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICBjdHgucGF0aC5wdXNoKGZpZWxkKTtcblxuICAgICAgaWYgKCFhbGxvd2VkQ2hpbGRyZW4uaW5jbHVkZXMoZmllbGQpICYmIGZpZWxkLmluZGV4T2YoJ3gtJykgIT09IDApIHtcbiAgICAgICAgY3R4LnJlc3VsdC5wdXNoKGNyZWF0ZUVycm9yKCdUaGlzIGZpZWxkIGlzIG5vdCBwZXJtaXR0ZWQgaGVyZScsIG5vZGUsIGN0eCwgJ2tleScpKTtcbiAgICAgIH1cblxuICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgfSk7XG5cbiAgICBPYmplY3Qua2V5cyhkZWZpbml0aW9uLnZhbGlkYXRvcnMpLmZvckVhY2goKHYpID0+IHtcbiAgICAgIGlmIChPYmplY3Qua2V5cyhub2RlKS5pbmNsdWRlcyh2KSkgY3R4LnBhdGgucHVzaCh2KTtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBkZWZpbml0aW9uLnZhbGlkYXRvcnNbdl0oKShub2RlLCBjdHgpO1xuICAgICAgaWYgKE9iamVjdC5rZXlzKG5vZGUpLmluY2x1ZGVzKHYpKSBjdHgucGF0aC5wb3AoKTtcbiAgICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0KSBjdHgucmVzdWx0LnB1c2godmFsaWRhdGlvblJlc3VsdCk7XG4gICAgfSk7XG4gIH1cbn07XG5cbmNvbnN0IHRyYXZlcnNlTm9kZSA9IChub2RlLCBkZWZpbml0aW9uLCBjdHgpID0+IHtcbiAgY29uc3QgY3VycmVudFBhdGggPSBjdHgucGF0aC5qb2luKCcvJyk7XG5cbiAgLy8gVE8tRE86IHJlZmFjdG9yIGN0eC52aXNpdGVkIGludG8gZGljdGlvbmFyeSBmb3IgTygxKSBjaGVjayB0aW1lXG4gIGlmIChjdHgudmlzaXRlZC5pbmNsdWRlcyhjdXJyZW50UGF0aCkpIHJldHVybjtcbiAgY3R4LnZpc2l0ZWQucHVzaChjdXJyZW50UGF0aCk7XG5cbiAgaWYgKCFub2RlIHx8ICFkZWZpbml0aW9uKSByZXR1cm47XG5cbiAgLy8gY29uc29sZS5sb2coYEN1cnJlbnQgcGF0aDogJHtjdXJyZW50UGF0aH1gKTtcbiAgbGV0IG5leHRQYXRoO1xuICBsZXQgcHJldlBhdGg7XG4gIGxldCByZXNvbHZlZE5vZGU7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItY29uc3RcbiAgKHsgbm9kZTogcmVzb2x2ZWROb2RlLCBuZXh0UGF0aCB9ID0gcmVzb2x2ZU5vZGUobm9kZSwgY3R4KSk7XG4gIGlmIChuZXh0UGF0aCkge1xuICAgIGN0eC5wYXRoU3RhY2sucHVzaChjdHgucGF0aCk7XG4gICAgcHJldlBhdGggPSBjdHgucGF0aDtcbiAgICBjdHgucGF0aCA9IG5leHRQYXRoLnJlcGxhY2UoJyMvJywgJycpLnNwbGl0KCcvJyk7XG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheShyZXNvbHZlZE5vZGUpKSB7XG4gICAgcmVzb2x2ZWROb2RlLmZvckVhY2goKG5vZGVDaGlsZCwgaSkgPT4ge1xuICAgICAgY3R4LnBhdGgucHVzaChpKTtcbiAgICAgIHRyYXZlcnNlTm9kZShub2RlQ2hpbGQsIGRlZmluaXRpb24sIGN0eCk7XG4gICAgICBjdHgucGF0aC5wb3AoKTtcbiAgICB9KTtcbiAgICBpZiAobmV4dFBhdGgpIGN0eC5wYXRoID0gcHJldlBhdGg7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgdmFsaWRhdGVOb2RlKHJlc29sdmVkTm9kZSwgZGVmaW5pdGlvbiwgY3R4KTtcblxuICBpZiAoZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKSB7XG4gICAgbGV0IG5vZGVDaGlsZHJlcztcbiAgICBzd2l0Y2ggKHR5cGVvZiBkZWZpbml0aW9uLnByb3BlcnRpZXMpIHtcbiAgICAgIGNhc2UgJ2Z1bmN0aW9uJzpcbiAgICAgICAgbm9kZUNoaWxkcmVzID0gZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKHJlc29sdmVkTm9kZSk7XG5cbiAgICAgICAgT2JqZWN0LmtleXMobm9kZUNoaWxkcmVzKS5mb3JFYWNoKChjaGlsZCkgPT4ge1xuICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhyZXNvbHZlZE5vZGUpLmluY2x1ZGVzKGNoaWxkKSkge1xuICAgICAgICAgICAgY3R4LnBhdGgucHVzaChjaGlsZCk7XG4gICAgICAgICAgICBpZiAocmVzb2x2ZWROb2RlW2NoaWxkXSkgdHJhdmVyc2VOb2RlKHJlc29sdmVkTm9kZVtjaGlsZF0sIG5vZGVDaGlsZHJlc1tjaGlsZF0sIGN0eCk7XG4gICAgICAgICAgICBjdHgucGF0aC5wb3AoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnb2JqZWN0JzpcblxuICAgICAgICBPYmplY3Qua2V5cyhkZWZpbml0aW9uLnByb3BlcnRpZXMpLmZvckVhY2goKHApID0+IHtcbiAgICAgICAgICBjdHgucGF0aC5wdXNoKHApO1xuICAgICAgICAgIGlmICh0eXBlb2YgZGVmaW5pdGlvbi5wcm9wZXJ0aWVzW3BdID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBpZiAocmVzb2x2ZWROb2RlW3BdKSB0cmF2ZXJzZU5vZGUocmVzb2x2ZWROb2RlW3BdLCBkZWZpbml0aW9uLnByb3BlcnRpZXNbcF0oKSwgY3R4KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKG5vZGVbcF0pIHtcbiAgICAgICAgICAgIHRyYXZlcnNlTm9kZShyZXNvbHZlZE5vZGVbcF0sIGRlZmluaXRpb24ucHJvcGVydGllc1twXSwgY3R4KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIGlmIChuZXh0UGF0aCkgY3R4LnBhdGggPSBjdHgucGF0aFN0YWNrLnBvcCgpO1xufTtcblxuY29uc3QgdHJhdmVyc2UgPSAobm9kZSwgZGVmaW5pdGlvbiwgc291cmNlRmlsZSkgPT4ge1xuICBjb25zdCBjdHggPSB7XG4gICAgZG9jdW1lbnQ6IG5vZGUsXG4gICAgcGF0aDogW10sXG4gICAgdmlzaXRlZDogW10sXG4gICAgcmVzdWx0OiBbXSxcbiAgICBwYXRoU3RhY2s6IFtdLFxuICAgIHNvdXJjZTogc291cmNlRmlsZSxcbiAgICAvLyBlbmFibGVDb2RlZnJhbWU6IHRydWUsXG4gIH07XG4gIHRyYXZlcnNlTm9kZShub2RlLCBkZWZpbml0aW9uLCBjdHgpO1xuICByZXR1cm4gY3R4LnJlc3VsdDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHRyYXZlcnNlO1xuIl19