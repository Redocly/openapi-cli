"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _resolver = _interopRequireDefault(require("./resolver"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const validateNode = (node, definition, ctx) => {
  if (node && definition && definition.validators) {
    Object.keys(definition.validators).forEach(v => {
      ctx.path.push(v);
      const validationResult = definition.validators[v]()(node, ctx);
      ctx.path.pop();
      if (validationResult) ctx.result.push(validationResult);
    });
  }
};

const traverseNode = (node, definition, ctx) => {
  const currentPath = ctx.path.join('/'); // TO-DO: refactor ctx.visited into dictionary for O(1) check time

  if (ctx.visited.includes(currentPath)) return;
  ctx.visited.push(currentPath);
  if (!node || !definition) return; // console.log(`Current path: ${currentPath}`);

  let nextPath;
  let prevPath;
  let resolvedNode; // eslint-disable-next-line prefer-const

  ({
    node: resolvedNode,
    nextPath
  } = (0, _resolver.default)(node, ctx));

  if (nextPath) {
    ctx.pathStack.push(ctx.path);
    prevPath = ctx.path;
    ctx.path = nextPath.replace('#/', '').split('/');
  }

  if (Array.isArray(resolvedNode)) {
    resolvedNode.forEach((nodeChild, i) => {
      ctx.path.push(i);
      traverseNode(nodeChild, definition, ctx);
      ctx.path.pop();
    });
    if (nextPath) ctx.path = prevPath;
    return;
  }

  validateNode(resolvedNode, definition, ctx);

  if (definition.properties) {
    let nodeChildres;

    switch (typeof definition.properties) {
      case 'function':
        nodeChildres = definition.properties(resolvedNode);
        Object.keys(nodeChildres).forEach(child => {
          if (Object.keys(resolvedNode).includes(child)) {
            ctx.path.push(child);
            if (resolvedNode[child]) traverseNode(resolvedNode[child], nodeChildres[child], ctx);
            ctx.path.pop();
          }
        });
        break;

      case 'object':
        Object.keys(definition.properties).forEach(p => {
          ctx.path.push(p);

          if (typeof definition.properties[p] === 'function') {
            if (resolvedNode[p]) traverseNode(resolvedNode[p], definition.properties[p](), ctx);
          } else if (node[p]) {
            traverseNode(resolvedNode[p], definition.properties[p], ctx);
          }

          ctx.path.pop();
        });
        break;

      default:
        break;
    }
  }

  if (nextPath) ctx.path = ctx.pathStack.pop();
};

const traverse = (node, definition, sourceFile) => {
  const ctx = {
    document: node,
    path: [],
    visited: [],
    result: [],
    pathStack: [],
    source: sourceFile
  };
  traverseNode(node, definition, ctx);
  return ctx.result;
};

var _default = traverse;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmF2ZXJzZS5qcyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZU5vZGUiLCJub2RlIiwiZGVmaW5pdGlvbiIsImN0eCIsInZhbGlkYXRvcnMiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsInYiLCJwYXRoIiwicHVzaCIsInZhbGlkYXRpb25SZXN1bHQiLCJwb3AiLCJyZXN1bHQiLCJ0cmF2ZXJzZU5vZGUiLCJjdXJyZW50UGF0aCIsImpvaW4iLCJ2aXNpdGVkIiwiaW5jbHVkZXMiLCJuZXh0UGF0aCIsInByZXZQYXRoIiwicmVzb2x2ZWROb2RlIiwicGF0aFN0YWNrIiwicmVwbGFjZSIsInNwbGl0IiwiQXJyYXkiLCJpc0FycmF5Iiwibm9kZUNoaWxkIiwiaSIsInByb3BlcnRpZXMiLCJub2RlQ2hpbGRyZXMiLCJjaGlsZCIsInAiLCJ0cmF2ZXJzZSIsInNvdXJjZUZpbGUiLCJkb2N1bWVudCIsInNvdXJjZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLENBQUNDLElBQUQsRUFBT0MsVUFBUCxFQUFtQkMsR0FBbkIsS0FBMkI7QUFDOUMsTUFBSUYsSUFBSSxJQUFJQyxVQUFSLElBQXNCQSxVQUFVLENBQUNFLFVBQXJDLEVBQWlEO0FBQy9DQyxJQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWUosVUFBVSxDQUFDRSxVQUF2QixFQUFtQ0csT0FBbkMsQ0FBNENDLENBQUQsSUFBTztBQUNoREwsTUFBQUEsR0FBRyxDQUFDTSxJQUFKLENBQVNDLElBQVQsQ0FBY0YsQ0FBZDtBQUNBLFlBQU1HLGdCQUFnQixHQUFHVCxVQUFVLENBQUNFLFVBQVgsQ0FBc0JJLENBQXRCLElBQTJCUCxJQUEzQixFQUFpQ0UsR0FBakMsQ0FBekI7QUFDQUEsTUFBQUEsR0FBRyxDQUFDTSxJQUFKLENBQVNHLEdBQVQ7QUFDQSxVQUFJRCxnQkFBSixFQUFzQlIsR0FBRyxDQUFDVSxNQUFKLENBQVdILElBQVgsQ0FBZ0JDLGdCQUFoQjtB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QUFHLENBQUNVLE1BQVg7QUFDRCxDQVhEOztlQWFlb0IsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXNvbHZlTm9kZSBmcm9tICcuL3Jlc29sdmVyJztcblxuY29uc3QgdmFsaWRhdGVOb2RlID0gKG5vZGUsIGRlZmluaXRpb24sIGN0eCkgPT4ge1xuICBpZiAobm9kZSAmJiBkZWZpbml0aW9uICYmIGRlZmluaXRpb24udmFsaWRhdG9ycykge1xuICAgIE9iamVjdC5rZXlzKGRlZmluaXRpb24udmFsaWRhdG9ycykuZm9yRWFjaCgodikgPT4ge1xuICAgICAgY3R4LnBhdGgucHVzaCh2KTtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBkZWZpbml0aW9uLnZhbGlkYXRvcnNbdl0oKShub2RlLCBjdHgpO1xuICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgICBpZiAodmFsaWRhdGlvblJlc3VsdCkgY3R4LnJlc3VsdC5wdXNoKHZhbGlkYXRpb25SZXN1bHQpO1xuICAgIH0pO1xuICB9XG59O1xuXG5jb25zdCB0cmF2ZXJzZU5vZGUgPSAobm9kZSwgZGVmaW5pdGlvbiwgY3R4KSA9PiB7XG4gIGNvbnN0IGN1cnJlbnRQYXRoID0gY3R4LnBhdGguam9pbignLycpO1xuXG4gIC8vIFRPLURPOiByZWZhY3RvciBjdHgudmlzaXRlZCBpbnRvIGRpY3Rpb25hcnkgZm9yIE8oMSkgY2hlY2sgdGltZVxuICBpZiAoY3R4LnZpc2l0ZWQuaW5jbHVkZXMoY3VycmVudFBhdGgpKSByZXR1cm47XG4gIGN0eC52aXNpdGVkLnB1c2goY3VycmVudFBhdGgpO1xuXG4gIGlmICghbm9kZSB8fCAhZGVmaW5pdGlvbikgcmV0dXJuO1xuXG4gIC8vIGNvbnNvbGUubG9nKGBDdXJyZW50IHBhdGg6ICR7Y3VycmVudFBhdGh9YCk7XG4gIGxldCBuZXh0UGF0aDtcbiAgbGV0IHByZXZQYXRoO1xuICBsZXQgcmVzb2x2ZWROb2RlO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWNvbnN0XG4gICh7IG5vZGU6IHJlc29sdmVkTm9kZSwgbmV4dFBhdGggfSA9IHJlc29sdmVOb2RlKG5vZGUsIGN0eCkpO1xuICBpZiAobmV4dFBhdGgpIHtcbiAgICBjdHgucGF0aFN0YWNrLnB1c2goY3R4LnBhdGgpO1xuICAgIHByZXZQYXRoID0gY3R4LnBhdGg7XG4gICAgY3R4LnBhdGggPSBuZXh0UGF0aC5yZXBsYWNlKCcjLycsICcnKS5zcGxpdCgnLycpO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkocmVzb2x2ZWROb2RlKSkge1xuICAgIHJlc29sdmVkTm9kZS5mb3JFYWNoKChub2RlQ2hpbGQsIGkpID0+IHtcbiAgICAgIGN0eC5wYXRoLnB1c2goaSk7XG4gICAgICB0cmF2ZXJzZU5vZGUobm9kZUNoaWxkLCBkZWZpbml0aW9uLCBjdHgpO1xuICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgfSk7XG4gICAgaWYgKG5leHRQYXRoKSBjdHgucGF0aCA9IHByZXZQYXRoO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHZhbGlkYXRlTm9kZShyZXNvbHZlZE5vZGUsIGRlZmluaXRpb24sIGN0eCk7XG5cbiAgaWYgKGRlZmluaXRpb24ucHJvcGVydGllcykge1xuICAgIGxldCBub2RlQ2hpbGRyZXM7XG4gICAgc3dpdGNoICh0eXBlb2YgZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKSB7XG4gICAgICBjYXNlICdmdW5jdGlvbic6XG4gICAgICAgIG5vZGVDaGlsZHJlcyA9IGRlZmluaXRpb24ucHJvcGVydGllcyhyZXNvbHZlZE5vZGUpO1xuXG4gICAgICAgIE9iamVjdC5rZXlzKG5vZGVDaGlsZHJlcykuZm9yRWFjaCgoY2hpbGQpID0+IHtcbiAgICAgICAgICBpZiAoT2JqZWN0LmtleXMocmVzb2x2ZWROb2RlKS5pbmNsdWRlcyhjaGlsZCkpIHtcbiAgICAgICAgICAgIGN0eC5wYXRoLnB1c2goY2hpbGQpO1xuICAgICAgICAgICAgaWYgKHJlc29sdmVkTm9kZVtjaGlsZF0pIHRyYXZlcnNlTm9kZShyZXNvbHZlZE5vZGVbY2hpbGRdLCBub2RlQ2hpbGRyZXNbY2hpbGRdLCBjdHgpO1xuICAgICAgICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ29iamVjdCc6XG5cbiAgICAgICAgT2JqZWN0LmtleXMoZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKS5mb3JFYWNoKChwKSA9PiB7XG4gICAgICAgICAgY3R4LnBhdGgucHVzaChwKTtcbiAgICAgICAgICBpZiAodHlwZW9mIGRlZmluaXRpb24ucHJvcGVydGllc1twXSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgaWYgKHJlc29sdmVkTm9kZVtwXSkgdHJhdmVyc2VOb2RlKHJlc29sdmVkTm9kZVtwXSwgZGVmaW5pdGlvbi5wcm9wZXJ0aWVzW3BdKCksIGN0eCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChub2RlW3BdKSB7XG4gICAgICAgICAgICB0cmF2ZXJzZU5vZGUocmVzb2x2ZWROb2RlW3BdLCBkZWZpbml0aW9uLnByb3BlcnRpZXNbcF0sIGN0eCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICBpZiAobmV4dFBhdGgpIGN0eC5wYXRoID0gY3R4LnBhdGhTdGFjay5wb3AoKTtcbn07XG5cbmNvbnN0IHRyYXZlcnNlID0gKG5vZGUsIGRlZmluaXRpb24sIHNvdXJjZUZpbGUpID0+IHtcbiAgY29uc3QgY3R4ID0ge1xuICAgIGRvY3VtZW50OiBub2RlLFxuICAgIHBhdGg6IFtdLFxuICAgIHZpc2l0ZWQ6IFtdLFxuICAgIHJlc3VsdDogW10sXG4gICAgcGF0aFN0YWNrOiBbXSxcbiAgICBzb3VyY2U6IHNvdXJjZUZpbGUsXG4gIH07XG4gIHRyYXZlcnNlTm9kZShub2RlLCBkZWZpbml0aW9uLCBjdHgpO1xuICByZXR1cm4gY3R4LnJlc3VsdDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHRyYXZlcnNlO1xuIl19