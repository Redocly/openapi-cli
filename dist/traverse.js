"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _resolver = _interopRequireDefault(require("./resolver"));

var _error = require("./error");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-use-before-define */
function validateNode(node, definition, ctx) {
  if (node && definition && definition.validators) {
    const allowedChildren = [...Object.keys(definition.properties || {}), ...Object.keys(definition.validators || {})];
    Object.keys(node).forEach(field => {
      ctx.path.push(field);

      if (!allowedChildren.includes(field) && field.indexOf('x-') !== 0 && field.indexOf('$ref') !== 0) {
        ctx.result.push((0, _error.createErrorFieldNotAllowed)(field, node, ctx));
      }

      ctx.path.pop();
    });
    Object.keys(definition.validators).forEach(v => {
      if (Object.keys(node).includes(v)) ctx.path.push(v);
      const validationResult = definition.validators[v]()(node, ctx);
      if (Object.keys(node).includes(v)) ctx.path.pop();
      if (validationResult) ctx.result.push(validationResult);
    });
  }
}

function traverseChildren(resolvedNode, definition, ctx) {
  if (definition.properties) {
    let nodeChildren;

    switch (typeof definition.properties) {
      case 'function':
        nodeChildren = definition.properties(resolvedNode);
        Object.keys(nodeChildren).forEach(child => {
          if (Object.keys(resolvedNode).includes(child)) {
            ctx.path.push(child);
            if (resolvedNode[child]) traverseNode(resolvedNode[child], nodeChildren[child], ctx);
            ctx.path.pop();
          }
        });
        break;

      case 'object':
        Object.keys(definition.properties).forEach(p => {
          ctx.path.push(p);

          if (typeof definition.properties[p] === 'function') {
            if (resolvedNode[p]) traverseNode(resolvedNode[p], definition.properties[p](), ctx);
          } else if (resolvedNode[p]) {
            traverseNode(resolvedNode[p], definition.properties[p], ctx);
          }

          ctx.path.pop();
        });
        break;

      default: // do nothing

    }
  }
}

function onNodeEnter(node, ctx) {
  let nextPath;
  let prevPath;
  let resolvedNode;
  let updatedSource;
  let prevSource;
  let filePath;
  let prevFilePath;
  ({
    // eslint-disable-next-line prefer-const
    node: resolvedNode,
    nextPath,
    updatedSource,
    filePath
  } = (0, _resolver.default)(node, ctx));

  if (nextPath) {
    ctx.pathStack.push(ctx.path);
    prevPath = ctx.path;
    ctx.path = nextPath;
  }

  if (updatedSource) {
    ctx.AST = null;
    prevFilePath = ctx.filePath;
    ctx.filePath = filePath;
    prevSource = ctx.source;
    ctx.source = updatedSource;
  }

  return {
    resolvedNode,
    prevPath,
    prevFilePath,
    prevSource
  };
}

function onNodeExit(nodeContext, ctx) {
  if (nodeContext.prevPath) {
    ctx.path = ctx.pathStack.pop();
  }

  if (nodeContext.prevSource) {
    ctx.AST = null;
    ctx.source = nodeContext.prevSource;
    ctx.filePath = nodeContext.prevFilePath;
  }
}

function traverseNode(node, definition, ctx) {
  const currentPath = ctx.path.join('/'); // TO-DO: refactor ctx.visited into dictionary for O(1) check time

  if (ctx.visited.includes(currentPath)) return;
  ctx.visited.push(currentPath);
  if (!node || !definition) return;
  const nodeContext = onNodeEnter(node, ctx);

  if (Array.isArray(nodeContext.resolvedNode)) {
    nodeContext.resolvedNode.forEach((nodeChild, i) => {
      ctx.path.push(i);
      traverseNode(nodeChild, definition, ctx);
      ctx.path.pop();
    });
    if (nodeContext.nextPath) ctx.path = nodeContext.prevPath;
    return;
  }

  validateNode(nodeContext.resolvedNode, definition, ctx);
  traverseChildren(nodeContext.resolvedNode, definition, ctx);
  onNodeExit(nodeContext, ctx);
}

const traverse = (node, definition, sourceFile, filePath = '') => {
  const ctx = {
    document: node,
    filePath,
    path: [],
    visited: [],
    result: [],
    pathStack: [],
    source: sourceFile,
    enableCodeframe: true
  };
  traverseNode(node, definition, ctx);
  return ctx.result;
};

var _default = traverse;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmF2ZXJzZS5qcyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZU5vZGUiLCJub2RlIiwiZGVmaW5pdGlvbiIsImN0eCIsInZhbGlkYXRvcnMiLCJhbGxvd2VkQ2hpbGRyZW4iLCJPYmplY3QiLCJrZXlzIiwicHJvcGVydGllcyIsImZvckVhY2giLCJmaWVsZCIsInBhdGgiLCJwdXNoIiwiaW5jbHVkZXMiLCJpbmRleE9mIiwicmVzdWx0IiwicG9wIiwidiIsInZhbGlkYXRpb25SZXN1bHQiLCJ0cmF2ZXJzZUNoaWxkcmVuIiwicmVzb2x2ZWROb2RlIiwibm9kZUNoaWxkcmVuIiwiY2hpbGQiLCJ0cmF2ZXJzZU5vZGUiLCJwIiwib25Ob2RlRW50ZXIiLCJuZXh0UGF0aCIsInByZXZQYXRoIiwidXBkYXRlZFNvdXJjZSIsInByZXZTb3VyY2UiLCJmaWxlUGF0aCIsInByZXZGaWxlUGF0aCIsInBhdGhTdGFjayIsIkFTVCIsInNvdXJjZSIsIm9uTm9kZUV4aXQiLCJub2RlQ29udGV4dCIsImN1cnJlbnRQYXRoIiwiam9pbiIsInZpc2l0ZWQiLCJBcnJheSIsImlzQXJyYXkiLCJub2RlQ2hpbGQiLCJpIiwidHJhdmVyc2UiLCJzb3VyY2VGaWxlIiwiZG9jdW1lbnQiLCJlbmFibGVDb2RlZnJhbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7OztBQUZBO0FBSUEsU0FBU0EsWUFBVCxDQUFzQkMsSUFBdEIsRUFBNEJDLFVBQTVCLEVBQXdDQyxHQUF4QyxFQUE2QztBQUMzQyxNQUFJRixJQUFJLElBQUlDLFVBQVIsSUFBc0JBLFVBQVUsQ0FBQ0UsVUFBckMsRUFBaUQ7QUFDL0MsVUFBTUMsZUFBZSxHQUFHLENBQ3RCLEdBQUlDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZTCxVQUFVLENBQUNNLFVBQVgsSUFBeUIsRUFBckMsQ0FEa0IsRUFFdEIsR0FBSUYsTUFBTSxDQUFDQyxJQUFQLENBQVlMLFVBQVUsQ0FBQ0UsVUFBWCxJQUF5QixFQUFyQyxDQUZr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TkQ7QUFPVkUsSUFBQUEsTUFBTSxFQUFFVyxVQVBFO0FBUVZFLElBQUFBLGVBQWUsRUFBRTtBQVJQLEdBQVo7QUFVQXhCLEVBQUFBLFlBQVksQ0FBQ3RCLElBQUQsRUFBT0MsVUFBUCxFQUFtQkMsR0FBbkIsQ0FBWjtBQUNBLFNBQU9BLEdBQUcsQ0FBQ1ksTUFBWDtBQUNELENBYkQ7O2VBZWU2QixRIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tdXNlLWJlZm9yZS1kZWZpbmUgKi9cbmltcG9ydCByZXNvbHZlTm9kZSBmcm9tICcuL3Jlc29sdmVyJztcbmltcG9ydCB7IGNyZWF0ZUVycm9yRmllbGROb3RBbGxvd2VkIH0gZnJvbSAnLi9lcnJvcic7XG5cbmZ1bmN0aW9uIHZhbGlkYXRlTm9kZShub2RlLCBkZWZpbml0aW9uLCBjdHgpIHtcbiAgaWYgKG5vZGUgJiYgZGVmaW5pdGlvbiAmJiBkZWZpbml0aW9uLnZhbGlkYXRvcnMpIHtcbiAgICBjb25zdCBhbGxvd2VkQ2hpbGRyZW4gPSBbXG4gICAgICAuLi4oT2JqZWN0LmtleXMoZGVmaW5pdGlvbi5wcm9wZXJ0aWVzIHx8IHt9KSksXG4gICAgICAuLi4oT2JqZWN0LmtleXMoZGVmaW5pdGlvbi52YWxpZGF0b3JzIHx8IHt9KSksXG4gICAgXTtcblxuICAgIE9iamVjdC5rZXlzKG5vZGUpLmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICBjdHgucGF0aC5wdXNoKGZpZWxkKTtcblxuICAgICAgaWYgKCFhbGxvd2VkQ2hpbGRyZW4uaW5jbHVkZXMoZmllbGQpICYmIGZpZWxkLmluZGV4T2YoJ3gtJykgIT09IDAgJiYgZmllbGQuaW5kZXhPZignJHJlZicpICE9PSAwKSB7XG4gICAgICAgIGN0eC5yZXN1bHQucHVzaChjcmVhdGVFcnJvckZpZWxkTm90QWxsb3dlZChmaWVsZCwgbm9kZSwgY3R4KSk7XG4gICAgICB9XG5cbiAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgIH0pO1xuXG4gICAgT2JqZWN0LmtleXMoZGVmaW5pdGlvbi52YWxpZGF0b3JzKS5mb3JFYWNoKCh2KSA9PiB7XG4gICAgICBpZiAoT2JqZWN0LmtleXMobm9kZSkuaW5jbHVkZXModikpIGN0eC5wYXRoLnB1c2godik7XG4gICAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gZGVmaW5pdGlvbi52YWxpZGF0b3JzW3ZdKCkobm9kZSwgY3R4KTtcbiAgICAgIGlmIChPYmplY3Qua2V5cyhub2RlKS5pbmNsdWRlcyh2KSkgY3R4LnBhdGgucG9wKCk7XG4gICAgICBpZiAodmFsaWRhdGlvblJlc3VsdCkgY3R4LnJlc3VsdC5wdXNoKHZhbGlkYXRpb25SZXN1bHQpO1xuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHRyYXZlcnNlQ2hpbGRyZW4ocmVzb2x2ZWROb2RlLCBkZWZpbml0aW9uLCBjdHgpIHtcbiAgaWYgKGRlZmluaXRpb24ucHJvcGVydGllcykge1xuICAgIGxldCBub2RlQ2hpbGRyZW47XG4gICAgc3dpdGNoICh0eXBlb2YgZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKSB7XG4gICAgICBjYXNlICdmdW5jdGlvbic6XG4gICAgICAgIG5vZGVDaGlsZHJlbiA9IGRlZmluaXRpb24ucHJvcGVydGllcyhyZXNvbHZlZE5vZGUpO1xuICAgICAgICBPYmplY3Qua2V5cyhub2RlQ2hpbGRyZW4pLmZvckVhY2goKGNoaWxkKSA9PiB7XG4gICAgICAgICAgaWYgKE9iamVjdC5rZXlzKHJlc29sdmVkTm9kZSkuaW5jbHVkZXMoY2hpbGQpKSB7XG4gICAgICAgICAgICBjdHgucGF0aC5wdXNoKGNoaWxkKTtcbiAgICAgICAgICAgIGlmIChyZXNvbHZlZE5vZGVbY2hpbGRdKSB0cmF2ZXJzZU5vZGUocmVzb2x2ZWROb2RlW2NoaWxkXSwgbm9kZUNoaWxkcmVuW2NoaWxkXSwgY3R4KTtcbiAgICAgICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdvYmplY3QnOlxuICAgICAgICBPYmplY3Qua2V5cyhkZWZpbml0aW9uLnByb3BlcnRpZXMpLmZvckVhY2goKHApID0+IHtcbiAgICAgICAgICBjdHgucGF0aC5wdXNoKHApO1xuICAgICAgICAgIGlmICh0eXBlb2YgZGVmaW5pdGlvbi5wcm9wZXJ0aWVzW3BdID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBpZiAocmVzb2x2ZWROb2RlW3BdKSB0cmF2ZXJzZU5vZGUocmVzb2x2ZWROb2RlW3BdLCBkZWZpbml0aW9uLnByb3BlcnRpZXNbcF0oKSwgY3R4KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc29sdmVkTm9kZVtwXSkge1xuICAgICAgICAgICAgdHJhdmVyc2VOb2RlKHJlc29sdmVkTm9kZVtwXSwgZGVmaW5pdGlvbi5wcm9wZXJ0aWVzW3BdLCBjdHgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjdHgucGF0aC5wb3AoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG9uTm9kZUVudGVyKG5vZGUsIGN0eCkge1xuICBsZXQgbmV4dFBhdGg7XG4gIGxldCBwcmV2UGF0aDtcbiAgbGV0IHJlc29sdmVkTm9kZTtcbiAgbGV0IHVwZGF0ZWRTb3VyY2U7XG4gIGxldCBwcmV2U291cmNlO1xuICBsZXQgZmlsZVBhdGg7XG4gIGxldCBwcmV2RmlsZVBhdGg7XG4gICh7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1jb25zdFxuICAgIG5vZGU6IHJlc29sdmVkTm9kZSwgbmV4dFBhdGgsIHVwZGF0ZWRTb3VyY2UsIGZpbGVQYXRoLFxuICB9ID0gcmVzb2x2ZU5vZGUobm9kZSwgY3R4KSk7XG5cbiAgaWYgKG5leHRQYXRoKSB7XG4gICAgY3R4LnBhdGhTdGFjay5wdXNoKGN0eC5wYXRoKTtcbiAgICBwcmV2UGF0aCA9IGN0eC5wYXRoO1xuICAgIGN0eC5wYXRoID0gbmV4dFBhdGg7XG4gIH1cblxuICBpZiAodXBkYXRlZFNvdXJjZSkge1xuICAgIGN0eC5BU1QgPSBudWxsO1xuICAgIHByZXZGaWxlUGF0aCA9IGN0eC5maWxlUGF0aDtcbiAgICBjdHguZmlsZVBhdGggPSBmaWxlUGF0aDtcbiAgICBwcmV2U291cmNlID0gY3R4LnNvdXJjZTtcbiAgICBjdHguc291cmNlID0gdXBkYXRlZFNvdXJjZTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcmVzb2x2ZWROb2RlLFxuICAgIHByZXZQYXRoLFxuICAgIHByZXZGaWxlUGF0aCxcbiAgICBwcmV2U291cmNlLFxuICB9O1xufVxuXG5mdW5jdGlvbiBvbk5vZGVFeGl0KG5vZGVDb250ZXh0LCBjdHgpIHtcbiAgaWYgKG5vZGVDb250ZXh0LnByZXZQYXRoKSB7XG4gICAgY3R4LnBhdGggPSBjdHgucGF0aFN0YWNrLnBvcCgpO1xuICB9XG4gIGlmIChub2RlQ29udGV4dC5wcmV2U291cmNlKSB7XG4gICAgY3R4LkFTVCA9IG51bGw7XG4gICAgY3R4LnNvdXJjZSA9IG5vZGVDb250ZXh0LnByZXZTb3VyY2U7XG4gICAgY3R4LmZpbGVQYXRoID0gbm9kZUNvbnRleHQucHJldkZpbGVQYXRoO1xuICB9XG59XG5cbmZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBkZWZpbml0aW9uLCBjdHgpIHtcbiAgY29uc3QgY3VycmVudFBhdGggPSBjdHgucGF0aC5qb2luKCcvJyk7XG5cbiAgLy8gVE8tRE86IHJlZmFjdG9yIGN0eC52aXNpdGVkIGludG8gZGljdGlvbmFyeSBmb3IgTygxKSBjaGVjayB0aW1lXG4gIGlmIChjdHgudmlzaXRlZC5pbmNsdWRlcyhjdXJyZW50UGF0aCkpIHJldHVybjtcbiAgY3R4LnZpc2l0ZWQucHVzaChjdXJyZW50UGF0aCk7XG5cbiAgaWYgKCFub2RlIHx8ICFkZWZpbml0aW9uKSByZXR1cm47XG5cbiAgY29uc3Qgbm9kZUNvbnRleHQgPSBvbk5vZGVFbnRlcihub2RlLCBjdHgpO1xuXG4gIGlmIChBcnJheS5pc0FycmF5KG5vZGVDb250ZXh0LnJlc29sdmVkTm9kZSkpIHtcbiAgICBub2RlQ29udGV4dC5yZXNvbHZlZE5vZGUuZm9yRWFjaCgobm9kZUNoaWxkLCBpKSA9PiB7XG4gICAgICBjdHgucGF0aC5wdXNoKGkpO1xuICAgICAgdHJhdmVyc2VOb2RlKG5vZGVDaGlsZCwgZGVmaW5pdGlvbiwgY3R4KTtcbiAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgIH0pO1xuICAgIGlmIChub2RlQ29udGV4dC5uZXh0UGF0aCkgY3R4LnBhdGggPSBub2RlQ29udGV4dC5wcmV2UGF0aDtcbiAgICByZXR1cm47XG4gIH1cblxuICB2YWxpZGF0ZU5vZGUobm9kZUNvbnRleHQucmVzb2x2ZWROb2RlLCBkZWZpbml0aW9uLCBjdHgpO1xuICB0cmF2ZXJzZUNoaWxkcmVuKG5vZGVDb250ZXh0LnJlc29sdmVkTm9kZSwgZGVmaW5pdGlvbiwgY3R4KTtcblxuICBvbk5vZGVFeGl0KG5vZGVDb250ZXh0LCBjdHgpO1xufVxuXG5jb25zdCB0cmF2ZXJzZSA9IChub2RlLCBkZWZpbml0aW9uLCBzb3VyY2VGaWxlLCBmaWxlUGF0aCA9ICcnKSA9PiB7XG4gIGNvbnN0IGN0eCA9IHtcbiAgICBkb2N1bWVudDogbm9kZSxcbiAgICBmaWxlUGF0aCxcbiAgICBwYXRoOiBbXSxcbiAgICB2aXNpdGVkOiBbXSxcbiAgICByZXN1bHQ6IFtdLFxuICAgIHBhdGhTdGFjazogW10sXG4gICAgc291cmNlOiBzb3VyY2VGaWxlLFxuICAgIGVuYWJsZUNvZGVmcmFtZTogdHJ1ZSxcbiAgfTtcbiAgdHJhdmVyc2VOb2RlKG5vZGUsIGRlZmluaXRpb24sIGN0eCk7XG4gIHJldHVybiBjdHgucmVzdWx0O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgdHJhdmVyc2U7XG4iXX0=