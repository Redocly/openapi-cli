"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _resolver = _interopRequireDefault(require("./resolver"));

var _error = require("./error");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-use-before-define */
function validateNode(node, definition, ctx) {
  if (node && definition && definition.validators) {
    const allowedChildren = [...Object.keys(definition.properties || {}), ...Object.keys(definition.validators || {})];
    Object.keys(node).forEach(field => {
      ctx.path.push(field);

      if (!allowedChildren.includes(field) && field.indexOf('x-') !== 0 && field.indexOf('$ref') !== 0) {
        ctx.result.push((0, _error.createErrorFieldNotAllowed)(field, node, ctx));
      }

      ctx.path.pop();
    });
    Object.keys(definition.validators).forEach(v => {
      if (Object.keys(node).includes(v)) ctx.path.push(v);
      const validationResult = definition.validators[v]()(node, ctx);
      if (Object.keys(node).includes(v)) ctx.path.pop();
      if (validationResult) ctx.result.push(validationResult);
    });
  }
}

function traverseChildren(resolvedNode, definition, ctx) {
  if (definition.properties) {
    let nodeChildren;

    switch (typeof definition.properties) {
      case 'function':
        nodeChildren = definition.properties(resolvedNode);
        Object.keys(nodeChildren).forEach(child => {
          if (Object.keys(resolvedNode).includes(child)) {
            ctx.path.push(child);
            if (resolvedNode[child]) traverseNode(resolvedNode[child], nodeChildren[child], ctx);
            ctx.path.pop();
          }
        });
        break;

      case 'object':
        Object.keys(definition.properties).forEach(p => {
          ctx.path.push(p);

          if (typeof definition.properties[p] === 'function') {
            if (resolvedNode[p]) traverseNode(resolvedNode[p], definition.properties[p](), ctx);
          } else if (resolvedNode[p]) {
            traverseNode(resolvedNode[p], definition.properties[p], ctx);
          }

          ctx.path.pop();
        });
        break;

      default: // do nothing

    }
  }
}

function onNodeEnter(node, ctx) {
  let nextPath;
  let prevPath;
  let resolvedNode;
  let updatedSource;
  let prevSource;
  let filePath;
  let prevFilePath;
  ({
    // eslint-disable-next-line prefer-const
    node: resolvedNode,
    nextPath,
    updatedSource,
    filePath
  } = (0, _resolver.default)(node, ctx));

  if (nextPath) {
    ctx.pathStack.push({
      path: ctx.path,
      file: ctx.filePath
    });
    prevPath = ctx.path;
    ctx.path = nextPath;
  }

  if (updatedSource) {
    ctx.AST = null;
    prevFilePath = ctx.filePath;
    ctx.filePath = filePath;
    prevSource = ctx.source;
    ctx.source = updatedSource;
  }

  return {
    resolvedNode,
    prevPath,
    prevFilePath,
    prevSource
  };
}

function onNodeExit(nodeContext, ctx) {
  if (nodeContext.prevPath) {
    const fromStack = ctx.pathStack.pop();
    ctx.path = fromStack.path;
  }

  if (nodeContext.prevFilePath) {
    ctx.AST = null;
    ctx.source = nodeContext.prevSource;
    ctx.filePath = nodeContext.prevFilePath;
  }
}

function traverseNode(node, definition, ctx) {
  if (!node || !definition) return;
  const nodeContext = onNodeEnter(node, ctx);
  const currentPath = `${ctx.filePath}::${ctx.path.join('/')}`; // TO-DO: refactor ctx.visited into dictionary for O(1) check time

  if (ctx.visited.includes(currentPath)) {
    onNodeExit(nodeContext, ctx);
    return;
  }

  ctx.visited.push(currentPath); // console.log(`${ctx.filePath}::${currentPath}`);

  if (Array.isArray(nodeContext.resolvedNode)) {
    nodeContext.resolvedNode.forEach((nodeChild, i) => {
      ctx.path.push(i);
      traverseNode(nodeChild, definition, ctx);
      ctx.path.pop();
    });
    if (nodeContext.nextPath) ctx.path = nodeContext.prevPath;
  } else {
    // can use async / promises here
    ctx.customRules.forEach(rule => {
      const errors = rule.onEnter ? rule.onEnter(nodeContext.resolvedNode, definition, { ...ctx
      }) : [];
      if (errors) ctx.result.push(...errors);
    });
    validateNode(nodeContext.resolvedNode, definition, ctx);
    traverseChildren(nodeContext.resolvedNode, definition, ctx); // can use async / promises here

    ctx.customRules.forEach(rule => {
      const errors = rule.onExit ? rule.onExit(nodeContext.resolvedNode, definition, ctx) : [];
      if (errors) ctx.result.push(...errors);
    });
  }

  onNodeExit(nodeContext, ctx);
}

var _default = traverseNode;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmF2ZXJzZS5qcyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZU5vZGUiLCJub2RlIiwiZGVmaW5pdGlvbiIsImN0eCIsInZhbGlkYXRvcnMiLCJhbGxvd2VkQ2hpbGRyZW4iLCJPYmplY3QiLCJrZXlzIiwicHJvcGVydGllcyIsImZvckVhY2giLCJmaWVsZCIsInBhdGgiLCJwdXNoIiwiaW5jbHVkZXMiLCJpbmRleE9mIiwicmVzdWx0IiwicG9wIiwidiIsInZhbGlkYXRpb25SZXN1bHQiLCJ0cmF2ZXJzZUNoaWxkcmVuIiwicmVzb2x2ZWROb2RlIiwibm9kZUNoaWxkcmVuIiwiY2hpbGQiLCJ0cmF2ZXJzZU5vZGUiLCJwIiwib25Ob2RlRW50ZXIiLCJuZXh0UGF0aCIsInByZXZQYXRoIiwidXBkYXRlZFNvdXJjZSIsInByZXZTb3VyY2UiLCJmaWxlUGF0aCIsInByZXZGaWxlUGF0aCIsInBhdGhTdGFjayIsImZpbGUiLCJBU1QiLCJzb3VyY2UiLCJvbk5vZGVFeGl0Iiwibm9kZUNvbnRleHQiLCJmcm9tU3RhY2siLCJjdXJyZW50UGF0aCIsImpvaW4iLCJ2aXNpdGVkIiwiQXJyYXkiLCJpc0FycmF5Iiwibm9kZUNoaWxkIiwiaSIsImN1c3RvbVJ1bGVzIiwicnVsZSIsImVycm9ycyIsIm9uRW50ZXIiLCJvbkV4aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7OztBQUZBO0FBSUEsU0FBU0EsWUFBVCxDQUFzQkMsSUFBdEIsRUFBNEJDLFVBQTVCLEVBQXdDQyxHQUF4QyxFQUE2QztBQUMzQyxNQUFJRixJQUFJLElBQUlDLFVBQVIsSUFBc0JBLFVBQVUsQ0FBQ0UsVUFBckMsRUFBaUQ7QUFDL0MsVUFBTUMsZUFBZSxHQUFHLENBQ3RCLEdBQUlDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZTCxVQUFVLENBQUNNLFVBQVgsSUFBeUIsRUFBckMsQ0FEa0IsRUFFdEIsR0FBSUYsTUFBTSxDQUFDQyxJQUFQLENBQVlMLFVBQVUsQ0FBQ0UsVUFBWCxJ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Q0FBQ1ksTUFBSixDQUFXSCxJQUFYLENBQWdCLEdBQUdvQyxNQUFuQjtBQUNiLEtBSkQ7QUFNQWhELElBQUFBLFlBQVksQ0FBQ3FDLFdBQVcsQ0FBQ2pCLFlBQWIsRUFBMkJsQixVQUEzQixFQUF1Q0MsR0FBdkMsQ0FBWjtBQUNBZ0IsSUFBQUEsZ0JBQWdCLENBQUNrQixXQUFXLENBQUNqQixZQUFiLEVBQTJCbEIsVUFBM0IsRUFBdUNDLEdBQXZDLENBQWhCLENBVEssQ0FXTDs7QUFDQUEsSUFBQUEsR0FBRyxDQUFDMkMsV0FBSixDQUFnQnJDLE9BQWhCLENBQXlCc0MsSUFBRCxJQUFVO0FBQ2hDLFlBQU1DLE1BQU0sR0FBR0QsSUFBSSxDQUFDRyxNQUFMLEdBQWNILElBQUksQ0FBQ0csTUFBTCxDQUFZYixXQUFXLENBQUNqQixZQUF4QixFQUFzQ2xCLFVBQXRDLEVBQWtEQyxHQUFsRCxDQUFkLEdBQXVFLEVBQXRGO0FBQ0EsVUFBSTZDLE1BQUosRUFBWTdDLEdBQUcsQ0FBQ1ksTUFBSixDQUFXSCxJQUFYLENBQWdCLEdBQUdvQyxNQUFuQjtBQUNiLEtBSEQ7QUFJRDs7QUFFRFosRUFBQUEsVUFBVSxDQUFDQyxXQUFELEVBQWNsQyxHQUFkLENBQVY7QUFDRDs7ZUFFY29CLFkiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby11c2UtYmVmb3JlLWRlZmluZSAqL1xuaW1wb3J0IHJlc29sdmVOb2RlIGZyb20gJy4vcmVzb2x2ZXInO1xuaW1wb3J0IHsgY3JlYXRlRXJyb3JGaWVsZE5vdEFsbG93ZWQgfSBmcm9tICcuL2Vycm9yJztcblxuZnVuY3Rpb24gdmFsaWRhdGVOb2RlKG5vZGUsIGRlZmluaXRpb24sIGN0eCkge1xuICBpZiAobm9kZSAmJiBkZWZpbml0aW9uICYmIGRlZmluaXRpb24udmFsaWRhdG9ycykge1xuICAgIGNvbnN0IGFsbG93ZWRDaGlsZHJlbiA9IFtcbiAgICAgIC4uLihPYmplY3Qua2V5cyhkZWZpbml0aW9uLnByb3BlcnRpZXMgfHwge30pKSxcbiAgICAgIC4uLihPYmplY3Qua2V5cyhkZWZpbml0aW9uLnZhbGlkYXRvcnMgfHwge30pKSxcbiAgICBdO1xuXG4gICAgT2JqZWN0LmtleXMobm9kZSkuZm9yRWFjaCgoZmllbGQpID0+IHtcbiAgICAgIGN0eC5wYXRoLnB1c2goZmllbGQpO1xuXG4gICAgICBpZiAoIWFsbG93ZWRDaGlsZHJlbi5pbmNsdWRlcyhmaWVsZCkgJiYgZmllbGQuaW5kZXhPZigneC0nKSAhPT0gMCAmJiBmaWVsZC5pbmRleE9mKCckcmVmJykgIT09IDApIHtcbiAgICAgICAgY3R4LnJlc3VsdC5wdXNoKGNyZWF0ZUVycm9yRmllbGROb3RBbGxvd2VkKGZpZWxkLCBub2RlLCBjdHgpKTtcbiAgICAgIH1cblxuICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgfSk7XG5cbiAgICBPYmplY3Qua2V5cyhkZWZpbml0aW9uLnZhbGlkYXRvcnMpLmZvckVhY2goKHYpID0+IHtcbiAgICAgIGlmIChPYmplY3Qua2V5cyhub2RlKS5pbmNsdWRlcyh2KSkgY3R4LnBhdGgucHVzaCh2KTtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBkZWZpbml0aW9uLnZhbGlkYXRvcnNbdl0oKShub2RlLCBjdHgpO1xuICAgICAgaWYgKE9iamVjdC5rZXlzKG5vZGUpLmluY2x1ZGVzKHYpKSBjdHgucGF0aC5wb3AoKTtcbiAgICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0KSBjdHgucmVzdWx0LnB1c2godmFsaWRhdGlvblJlc3VsdCk7XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdHJhdmVyc2VDaGlsZHJlbihyZXNvbHZlZE5vZGUsIGRlZmluaXRpb24sIGN0eCkge1xuICBpZiAoZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKSB7XG4gICAgbGV0IG5vZGVDaGlsZHJlbjtcbiAgICBzd2l0Y2ggKHR5cGVvZiBkZWZpbml0aW9uLnByb3BlcnRpZXMpIHtcbiAgICAgIGNhc2UgJ2Z1bmN0aW9uJzpcbiAgICAgICAgbm9kZUNoaWxkcmVuID0gZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKHJlc29sdmVkTm9kZSk7XG4gICAgICAgIE9iamVjdC5rZXlzKG5vZGVDaGlsZHJlbikuZm9yRWFjaCgoY2hpbGQpID0+IHtcbiAgICAgICAgICBpZiAoT2JqZWN0LmtleXMocmVzb2x2ZWROb2RlKS5pbmNsdWRlcyhjaGlsZCkpIHtcbiAgICAgICAgICAgIGN0eC5wYXRoLnB1c2goY2hpbGQpO1xuICAgICAgICAgICAgaWYgKHJlc29sdmVkTm9kZVtjaGlsZF0pIHRyYXZlcnNlTm9kZShyZXNvbHZlZE5vZGVbY2hpbGRdLCBub2RlQ2hpbGRyZW5bY2hpbGRdLCBjdHgpO1xuICAgICAgICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgIE9iamVjdC5rZXlzKGRlZmluaXRpb24ucHJvcGVydGllcykuZm9yRWFjaCgocCkgPT4ge1xuICAgICAgICAgIGN0eC5wYXRoLnB1c2gocCk7XG4gICAgICAgICAgaWYgKHR5cGVvZiBkZWZpbml0aW9uLnByb3BlcnRpZXNbcF0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGlmIChyZXNvbHZlZE5vZGVbcF0pIHRyYXZlcnNlTm9kZShyZXNvbHZlZE5vZGVbcF0sIGRlZmluaXRpb24ucHJvcGVydGllc1twXSgpLCBjdHgpO1xuICAgICAgICAgIH0gZWxzZSBpZiAocmVzb2x2ZWROb2RlW3BdKSB7XG4gICAgICAgICAgICB0cmF2ZXJzZU5vZGUocmVzb2x2ZWROb2RlW3BdLCBkZWZpbml0aW9uLnByb3BlcnRpZXNbcF0sIGN0eCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gb25Ob2RlRW50ZXIobm9kZSwgY3R4KSB7XG4gIGxldCBuZXh0UGF0aDtcbiAgbGV0IHByZXZQYXRoO1xuICBsZXQgcmVzb2x2ZWROb2RlO1xuICBsZXQgdXBkYXRlZFNvdXJjZTtcbiAgbGV0IHByZXZTb3VyY2U7XG4gIGxldCBmaWxlUGF0aDtcbiAgbGV0IHByZXZGaWxlUGF0aDtcbiAgKHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWNvbnN0XG4gICAgbm9kZTogcmVzb2x2ZWROb2RlLCBuZXh0UGF0aCwgdXBkYXRlZFNvdXJjZSwgZmlsZVBhdGgsXG4gIH0gPSByZXNvbHZlTm9kZShub2RlLCBjdHgpKTtcblxuICBpZiAobmV4dFBhdGgpIHtcbiAgICBjdHgucGF0aFN0YWNrLnB1c2goeyBwYXRoOiBjdHgucGF0aCwgZmlsZTogY3R4LmZpbGVQYXRoIH0pO1xuICAgIHByZXZQYXRoID0gY3R4LnBhdGg7XG4gICAgY3R4LnBhdGggPSBuZXh0UGF0aDtcbiAgfVxuXG4gIGlmICh1cGRhdGVkU291cmNlKSB7XG4gICAgY3R4LkFTVCA9IG51bGw7XG4gICAgcHJldkZpbGVQYXRoID0gY3R4LmZpbGVQYXRoO1xuICAgIGN0eC5maWxlUGF0aCA9IGZpbGVQYXRoO1xuICAgIHByZXZTb3VyY2UgPSBjdHguc291cmNlO1xuICAgIGN0eC5zb3VyY2UgPSB1cGRhdGVkU291cmNlO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICByZXNvbHZlZE5vZGUsXG4gICAgcHJldlBhdGgsXG4gICAgcHJldkZpbGVQYXRoLFxuICAgIHByZXZTb3VyY2UsXG4gIH07XG59XG5cbmZ1bmN0aW9uIG9uTm9kZUV4aXQobm9kZUNvbnRleHQsIGN0eCkge1xuICBpZiAobm9kZUNvbnRleHQucHJldlBhdGgpIHtcbiAgICBjb25zdCBmcm9tU3RhY2sgPSBjdHgucGF0aFN0YWNrLnBvcCgpO1xuICAgIGN0eC5wYXRoID0gZnJvbVN0YWNrLnBhdGg7XG4gIH1cbiAgaWYgKG5vZGVDb250ZXh0LnByZXZGaWxlUGF0aCkge1xuICAgIGN0eC5BU1QgPSBudWxsO1xuICAgIGN0eC5zb3VyY2UgPSBub2RlQ29udGV4dC5wcmV2U291cmNlO1xuICAgIGN0eC5maWxlUGF0aCA9IG5vZGVDb250ZXh0LnByZXZGaWxlUGF0aDtcbiAgfVxufVxuXG5mdW5jdGlvbiB0cmF2ZXJzZU5vZGUobm9kZSwgZGVmaW5pdGlvbiwgY3R4KSB7XG4gIGlmICghbm9kZSB8fCAhZGVmaW5pdGlvbikgcmV0dXJuO1xuICBjb25zdCBub2RlQ29udGV4dCA9IG9uTm9kZUVudGVyKG5vZGUsIGN0eCk7XG4gIGNvbnN0IGN1cnJlbnRQYXRoID0gYCR7Y3R4LmZpbGVQYXRofTo6JHtjdHgucGF0aC5qb2luKCcvJyl9YDtcblxuICAvLyBUTy1ETzogcmVmYWN0b3IgY3R4LnZpc2l0ZWQgaW50byBkaWN0aW9uYXJ5IGZvciBPKDEpIGNoZWNrIHRpbWVcbiAgaWYgKGN0eC52aXNpdGVkLmluY2x1ZGVzKGN1cnJlbnRQYXRoKSkge1xuICAgIG9uTm9kZUV4aXQobm9kZUNvbnRleHQsIGN0eCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGN0eC52aXNpdGVkLnB1c2goY3VycmVudFBhdGgpO1xuXG4gIC8vIGNvbnNvbGUubG9nKGAke2N0eC5maWxlUGF0aH06OiR7Y3VycmVudFBhdGh9YCk7XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkobm9kZUNvbnRleHQucmVzb2x2ZWROb2RlKSkge1xuICAgIG5vZGVDb250ZXh0LnJlc29sdmVkTm9kZS5mb3JFYWNoKChub2RlQ2hpbGQsIGkpID0+IHtcbiAgICAgIGN0eC5wYXRoLnB1c2goaSk7XG4gICAgICB0cmF2ZXJzZU5vZGUobm9kZUNoaWxkLCBkZWZpbml0aW9uLCBjdHgpO1xuICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgfSk7XG4gICAgaWYgKG5vZGVDb250ZXh0Lm5leHRQYXRoKSBjdHgucGF0aCA9IG5vZGVDb250ZXh0LnByZXZQYXRoO1xuICB9IGVsc2Uge1xuICAgIC8vIGNhbiB1c2UgYXN5bmMgLyBwcm9taXNlcyBoZXJlXG4gICAgY3R4LmN1c3RvbVJ1bGVzLmZvckVhY2goKHJ1bGUpID0+IHtcbiAgICAgIGNvbnN0IGVycm9ycyA9IHJ1bGUub25FbnRlclxuICAgICAgICA/IHJ1bGUub25FbnRlcihub2RlQ29udGV4dC5yZXNvbHZlZE5vZGUsIGRlZmluaXRpb24sIHsgLi4uY3R4IH0pIDogW107XG4gICAgICBpZiAoZXJyb3JzKSBjdHgucmVzdWx0LnB1c2goLi4uZXJyb3JzKTtcbiAgICB9KTtcblxuICAgIHZhbGlkYXRlTm9kZShub2RlQ29udGV4dC5yZXNvbHZlZE5vZGUsIGRlZmluaXRpb24sIGN0eCk7XG4gICAgdHJhdmVyc2VDaGlsZHJlbihub2RlQ29udGV4dC5yZXNvbHZlZE5vZGUsIGRlZmluaXRpb24sIGN0eCk7XG5cbiAgICAvLyBjYW4gdXNlIGFzeW5jIC8gcHJvbWlzZXMgaGVyZVxuICAgIGN0eC5jdXN0b21SdWxlcy5mb3JFYWNoKChydWxlKSA9PiB7XG4gICAgICBjb25zdCBlcnJvcnMgPSBydWxlLm9uRXhpdCA/IHJ1bGUub25FeGl0KG5vZGVDb250ZXh0LnJlc29sdmVkTm9kZSwgZGVmaW5pdGlvbiwgY3R4KSA6IFtdO1xuICAgICAgaWYgKGVycm9ycykgY3R4LnJlc3VsdC5wdXNoKC4uLmVycm9ycyk7XG4gICAgfSk7XG4gIH1cblxuICBvbk5vZGVFeGl0KG5vZGVDb250ZXh0LCBjdHgpO1xufVxuXG5leHBvcnQgZGVmYXVsdCB0cmF2ZXJzZU5vZGU7XG4iXX0=