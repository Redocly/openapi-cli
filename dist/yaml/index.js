"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.getCodeFrameForLocation = exports.getLocationByPathURI = exports.getLocationByPath = void 0;

var _yamlAstParser = require("yaml-ast-parser");

var _utils = require("../utils");

const parseAST = ctx => {
  if (ctx.AST) return ctx.AST;
  ctx.AST = (0, _yamlAstParser.safeLoad)(ctx.source);
  return ctx.AST;
};

const getMappingChild = (mapping, childName) => {
  const mappings = mapping.value ? mapping.value.mappings : mapping.mappings;
  const target = mappings.filter(child => child.key.value === childName);
  return target ? target[0] : null;
};

const getSequenceElement = (seq, id) => seq.value ? seq.value.items[id] : seq.items[id];

const getNodeByPath = (tree, path, target = 'value') => {
  if (path.length === 0) return target === 'value' ? tree : tree.key;
  const nextKey = path.pop();
  let next;

  if (tree.value && tree.value.mappings || tree.mappings) {
    next = getMappingChild(tree, nextKey);
  } else if (tree.value && tree.value.items || tree.items) {
    next = getSequenceElement(tree, nextKey);
  }

  return getNodeByPath(next, path, target);
};

const getLocationByPath = (path, ctx, target) => {
  const AST = parseAST(ctx);
  const node = getNodeByPath(AST, path.reverse(), target);
  if (!node) return null;
  const frame = ctx.source.substring(node.startPosition, node.endPosition + 1);
  const offset = frame.length - frame.trimRight().length;
  const positionStart = (0, _utils.getLineNumberFromId)(ctx.source, node.startPosition);
  const endPosition = (0, _utils.getLineNumberFromId)(ctx.source, node.endPosition - offset);
  return {
    startLine: positionStart.lineNum,
    startCol: positionStart.posNum,
    endLine: endPosition.lineNum,
    endCol: endPosition.posNum,
    startIndex: node.startPosition,
    endIndex: node.endPosition
  };
};

exports.getLocationByPath = getLocationByPath;

const getLocationByPathURI = (path, ctx, target) => {
  const pathArray = path.replace('#/', '').split('/');
  return getLocationByPath(pathArray, ctx, target);
};

exports.getLocationByPathURI = getLocationByPathURI;

const getCodeFrameForLocation = (start, end, source, startLine = 1, linesBefore = 3, linesAfter = 2) => {
  let frameStart = start;
  let frameEnd = end;
  let actualLinesBefore = 0;
  let actualLinesAfter = 0;

  for (; actualLinesBefore !== linesBefore && frameStart >= 0; frameStart -= 1) {
    if (source[frameStart - 1] === '\n') actualLinesBefore += 1;
  }

  for (; actualLinesAfter !== linesAfter && frameEnd !== source.length; frameEnd += 1) {
    if (source[frameEnd + 2] === '\n') actualLinesAfter += 1;
  }

  const codeFrame = source.substring(frameStart, frameEnd + 1);
  let startOffset = start - frameStart;
  let endOffset = startOffset + end - start;
  if (frameStart === -1) startOffset -= 1;
  if (frameStart === -1) endOffset -= 1;
  const codeFrameStart = codeFrame.substring(0, startOffset);
  const codeFrameEnd = codeFrame.substring(endOffset);
  const codeFrameMain = (0, _utils.outputUnderline)((0, _utils.outputRed)(codeFrame.substring(startOffset, endOffset)));
  let codeFrameString = `${codeFrameStart}${codeFrameMain}${codeFrameEnd}`;
  const lines = codeFrameString.split('\n');
  const maxLineNum = lines.length + startLine;
  let minSpaces = lines.reduce((acc, val) => val.length > acc ? val.length : acc, 0);
  lines.forEach(line => {
    let spaces;

    for (spaces = 0; line[spaces] === ' ' && spaces < line.length; spaces += 1);

    if (minSpaces > spaces) minSpaces = spaces;
  });
  lines.forEach((_, id) => {
    const lineNum = String(`0${startLine - actualLinesBefore + id}`).slice(-maxLineNum.toString().length);
    const line = minSpaces >= 4 ? lines[id].slice(minSpaces) : lines[id];

    if (id <= actualLinesBefore - 1 || id > lines.length - actualLinesAfter - 1) {
      lines[id] = (0, _utils.outputGrey)(`${lineNum}| ${line}`);
    } else {
      lines[id] = `${(0, _utils.outputGrey)(`${lineNum}|`)}${(0, _utils.outputRed)(` ${line}`)}`;
    }
  });
  codeFrameString = lines.join('\n');
  return codeFrameString;
};

exports.getCodeFrameForLocation = getCodeFrameForLocation;
var _default = getLocationByPath;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy95YW1sL2luZGV4LmpzIl0sIm5hbWVzIjpbInBhcnNlQVNUIiwiY3R4IiwiQVNUIiwic291cmNlIiwiZ2V0TWFwcGluZ0NoaWxkIiwibWFwcGluZyIsImNoaWxkTmFtZSIsIm1hcHBpbmdzIiwidmFsdWUiLCJ0YXJnZXQiLCJmaWx0ZXIiLCJjaGlsZCIsImtleSIsImdldFNlcXVlbmNlRWxlbWVudCIsInNlcSIsImlkIiwiaXRlbXMiLCJnZXROb2RlQnlQYXRoIiwidHJlZSIsInBhdGgiLCJsZW5ndGgiLCJuZXh0S2V5IiwicG9wIiwibmV4dCIsImdldExvY2F0aW9uQnlQYXRoIiwibm9kZSIsInJldmVyc2UiLCJmcmFtZSIsInN1YnN0cmluZyIsInN0YXJ0UG9zaXRpb24iLCJlbmRQb3NpdGlvbiIsIm9mZnNldCIsInRyaW1SaWdodCIsInBvc2l0aW9uU3RhcnQiLCJzdGFydExpbmUiLCJsaW5lTnVtIiwic3RhcnRDb2wiLCJwb3NOdW0iLCJlbmRMaW5lIiwiZW5kQ29sIiwic3RhcnRJbmRleCIsImVuZEluZGV4IiwiZ2V0TG9jYXRpb25CeVBhdGhVUkkiLCJwYXRoQXJyYXkiLCJyZXBsYWNlIiwic3BsaXQiLCJnZXRDb2RlRnJhbWVGb3JMb2NhdGlvbiIsInN0YXJ0IiwiZW5kIiwibGluZXNCZWZvcmUiLCJsaW5lc0FmdGVyIiwiZnJhbWVTdGFydCIsImZyYW1lRW5kIiwiYWN0dWFsTGluZXNCZWZvcmUiLCJhY3R1YWxMaW5lc0FmdGVyIiwiY29kZUZyYW1lIiwic3RhcnRPZmZzZXQiLCJlbmRPZmZzZXQiLCJjb2RlRnJhbWVTdGFydCIsImNvZGVGcmFtZUVuZCIsImNvZGVGcmFtZU1haW4iLCJjb2RlRnJhbWVTdHJpbmciLCJsaW5lcyIsIm1heExpbmVOdW0iLCJtaW5TcGFjZXMiLCJyZWR1Y2UiLCJhY2MiLCJ2YWwiLCJmb3JFYWNoIiwibGluZSIsInNwYWNlcyIsIl8iLCJTdHJpbmciLCJzbGljZSIsInRvU3RyaW5nIiwiam9pbiJd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LENBQUMxQyxNQUFOLEdBQWVrQyxnQkFBZixHQUFrQyxDQUExRSxFQUE2RTtBQUMzRVEsTUFBQUEsS0FBSyxDQUFDL0MsRUFBRCxDQUFMLEdBQVksdUJBQVksR0FBRW9CLE9BQVEsS0FBSWtDLElBQUssRUFBL0IsQ0FBWjtBQUNELEtBRkQsTUFFTztBQUNMUCxNQUFBQSxLQUFLLENBQUMvQyxFQUFELENBQUwsR0FBYSxHQUFFLHVCQUFZLEdBQUVvQixPQUFRLEdBQXRCLENBQTBCLEdBQUUsc0JBQVcsSUFBR2tDLElBQUssRUFBbkIsQ0FBc0IsRUFBakU7QUFDRDtBQUNGLEdBUkQ7QUFVQVIsRUFBQUEsZUFBZSxHQUFHQyxLQUFLLENBQUNhLElBQU4sQ0FBVyxJQUFYLENBQWxCO0FBRUEsU0FBT2QsZUFBUDtBQUNELENBdERNOzs7ZUF3RFFyQyxpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNhZmVMb2FkIH0gZnJvbSAneWFtbC1hc3QtcGFyc2VyJztcblxuaW1wb3J0IHtcbiAgb3V0cHV0UmVkLCBvdXRwdXRVbmRlcmxpbmUsIGdldExpbmVOdW1iZXJGcm9tSWQsIG91dHB1dEdyZXksXG59IGZyb20gJy4uL3V0aWxzJztcblxuY29uc3QgcGFyc2VBU1QgPSAoY3R4KSA9PiB7XG4gIGlmIChjdHguQVNUKSByZXR1cm4gY3R4LkFTVDtcbiAgY3R4LkFTVCA9IHNhZmVMb2FkKGN0eC5zb3VyY2UpO1xuICByZXR1cm4gY3R4LkFTVDtcbn07XG5cbmNvbnN0IGdldE1hcHBpbmdDaGlsZCA9IChtYXBwaW5nLCBjaGlsZE5hbWUpID0+IHtcbiAgY29uc3QgbWFwcGluZ3MgPSBtYXBwaW5nLnZhbHVlID8gbWFwcGluZy52YWx1ZS5tYXBwaW5ncyA6IG1hcHBpbmcubWFwcGluZ3M7XG4gIGNvbnN0IHRhcmdldCA9IG1hcHBpbmdzXG4gICAgLmZpbHRlcigoY2hpbGQpID0+IGNoaWxkLmtleS52YWx1ZSA9PT0gY2hpbGROYW1lKTtcbiAgcmV0dXJuIHRhcmdldCA/IHRhcmdldFswXSA6IG51bGw7XG59O1xuXG5jb25zdCBnZXRTZXF1ZW5jZUVsZW1lbnQgPSAoc2VxLCBpZCkgPT4gKHNlcS52YWx1ZSA/IHNlcS52YWx1ZS5pdGVtc1tpZF0gOiBzZXEuaXRlbXNbaWRdKTtcblxuY29uc3QgZ2V0Tm9kZUJ5UGF0aCA9ICh0cmVlLCBwYXRoLCB0YXJnZXQgPSAndmFsdWUnKSA9PiB7XG4gIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRhcmdldCA9PT0gJ3ZhbHVlJyA/IHRyZWUgOiB0cmVlLmtleTtcbiAgY29uc3QgbmV4dEtleSA9IHBhdGgucG9wKCk7XG4gIGxldCBuZXh0O1xuICBpZiAoKHRyZWUudmFsdWUgJiYgdHJlZS52YWx1ZS5tYXBwaW5ncykgfHwgdHJlZS5tYXBwaW5ncykge1xuICAgIG5leHQgPSBnZXRNYXBwaW5nQ2hpbGQodHJlZSwgbmV4dEtleSk7XG4gIH0gZWxzZSBpZiAoKHRyZWUudmFsdWUgJiYgdHJlZS52YWx1ZS5pdGVtcykgfHwgdHJlZS5pdGVtcykge1xuICAgIG5leHQgPSBnZXRTZXF1ZW5jZUVsZW1lbnQodHJlZSwgbmV4dEtleSk7XG4gIH1cbiAgcmV0dXJuIGdldE5vZGVCeVBhdGgobmV4dCwgcGF0aCwgdGFyZ2V0KTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRMb2NhdGlvbkJ5UGF0aCA9IChwYXRoLCBjdHgsIHRhcmdldCkgPT4ge1xuICBjb25zdCBBU1QgPSBwYXJzZUFTVChjdHgpO1xuICBjb25zdCBub2RlID0gZ2V0Tm9kZUJ5UGF0aChBU1QsIHBhdGgucmV2ZXJzZSgpLCB0YXJnZXQpO1xuICBpZiAoIW5vZGUpIHJldHVybiBudWxsO1xuXG4gIGNvbnN0IGZyYW1lID0gY3R4LnNvdXJjZS5zdWJzdHJpbmcobm9kZS5zdGFydFBvc2l0aW9uLCBub2RlLmVuZFBvc2l0aW9uICsgMSk7XG4gIGNvbnN0IG9mZnNldCA9IGZyYW1lLmxlbmd0aCAtIGZyYW1lLnRyaW1SaWdodCgpLmxlbmd0aDtcblxuICBjb25zdCBwb3NpdGlvblN0YXJ0ID0gZ2V0TGluZU51bWJlckZyb21JZChjdHguc291cmNlLCBub2RlLnN0YXJ0UG9zaXRpb24pO1xuICBjb25zdCBlbmRQb3NpdGlvbiA9IGdldExpbmVOdW1iZXJGcm9tSWQoY3R4LnNvdXJjZSwgbm9kZS5lbmRQb3NpdGlvbiAtIG9mZnNldCk7XG4gIHJldHVybiB7XG4gICAgc3RhcnRMaW5lOiBwb3NpdGlvblN0YXJ0LmxpbmVOdW0sXG4gICAgc3RhcnRDb2w6IHBvc2l0aW9uU3RhcnQucG9zTnVtLFxuICAgIGVuZExpbmU6IGVuZFBvc2l0aW9uLmxpbmVOdW0sXG4gICAgZW5kQ29sOiBlbmRQb3NpdGlvbi5wb3NOdW0sXG4gICAgc3RhcnRJbmRleDogbm9kZS5zdGFydFBvc2l0aW9uLFxuICAgIGVuZEluZGV4OiBub2RlLmVuZFBvc2l0aW9uLFxuICB9O1xufTtcblxuZXhwb3J0IGNvbnN0IGdldExvY2F0aW9uQnlQYXRoVVJJID0gKHBhdGgsIGN0eCwgdGFyZ2V0KSA9PiB7XG4gIGNvbnN0IHBhdGhBcnJheSA9IHBhdGgucmVwbGFjZSgnIy8nLCAnJykuc3BsaXQoJy8nKTtcbiAgcmV0dXJuIGdldExvY2F0aW9uQnlQYXRoKHBhdGhBcnJheSwgY3R4LCB0YXJnZXQpO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldENvZGVGcmFtZUZvckxvY2F0aW9uID0gKFxuICBzdGFydCwgZW5kLCBzb3VyY2UsIHN0YXJ0TGluZSA9IDEsIGxpbmVzQmVmb3JlID0gMywgbGluZXNBZnRlciA9IDIsXG4pID0+IHtcbiAgbGV0IGZyYW1lU3RhcnQgPSBzdGFydDtcbiAgbGV0IGZyYW1lRW5kID0gZW5kO1xuICBsZXQgYWN0dWFsTGluZXNCZWZvcmUgPSAwO1xuICBsZXQgYWN0dWFsTGluZXNBZnRlciA9IDA7XG5cbiAgZm9yICg7IGFjdHVhbExpbmVzQmVmb3JlICE9PSBsaW5lc0JlZm9yZSAmJiBmcmFtZVN0YXJ0ID49IDA7IGZyYW1lU3RhcnQgLT0gMSkge1xuICAgIGlmIChzb3VyY2VbZnJhbWVTdGFydCAtIDFdID09PSAnXFxuJykgYWN0dWFsTGluZXNCZWZvcmUgKz0gMTtcbiAgfVxuXG4gIGZvciAoOyBhY3R1YWxMaW5lc0FmdGVyICE9PSBsaW5lc0FmdGVyICYmIGZyYW1lRW5kICE9PSBzb3VyY2UubGVuZ3RoOyBmcmFtZUVuZCArPSAxKSB7XG4gICAgaWYgKHNvdXJjZVtmcmFtZUVuZCArIDJdID09PSAnXFxuJykgYWN0dWFsTGluZXNBZnRlciArPSAxO1xuICB9XG5cbiAgY29uc3QgY29kZUZyYW1lID0gc291cmNlLnN1YnN0cmluZyhmcmFtZVN0YXJ0LCBmcmFtZUVuZCArIDEpO1xuICBsZXQgc3RhcnRPZmZzZXQgPSBzdGFydCAtIGZyYW1lU3RhcnQ7XG4gIGxldCBlbmRPZmZzZXQgPSBzdGFydE9mZnNldCArIGVuZCAtIHN0YXJ0O1xuXG4gIGlmIChmcmFtZVN0YXJ0ID09PSAtMSkgc3RhcnRPZmZzZXQgLT0gMTtcbiAgaWYgKGZyYW1lU3RhcnQgPT09IC0xKSBlbmRPZmZzZXQgLT0gMTtcblxuICBjb25zdCBjb2RlRnJhbWVTdGFydCA9IGNvZGVGcmFtZS5zdWJzdHJpbmcoMCwgc3RhcnRPZmZzZXQpO1xuICBjb25zdCBjb2RlRnJhbWVFbmQgPSBjb2RlRnJhbWUuc3Vic3RyaW5nKGVuZE9mZnNldCk7XG4gIGNvbnN0IGNvZGVGcmFtZU1haW4gPSBvdXRwdXRVbmRlcmxpbmUob3V0cHV0UmVkKGNvZGVGcmFtZS5zdWJzdHJpbmcoc3RhcnRPZmZzZXQsIGVuZE9mZnNldCkpKTtcbiAgbGV0IGNvZGVGcmFtZVN0cmluZyA9IGAke2NvZGVGcmFtZVN0YXJ0fSR7Y29kZUZyYW1lTWFpbn0ke2NvZGVGcmFtZUVuZH1gO1xuXG4gIGNvbnN0IGxpbmVzID0gY29kZUZyYW1lU3RyaW5nLnNwbGl0KCdcXG4nKTtcblxuICBjb25zdCBtYXhMaW5lTnVtID0gbGluZXMubGVuZ3RoICsgc3RhcnRMaW5lO1xuXG4gIGxldCBtaW5TcGFjZXMgPSBsaW5lcy5yZWR1Y2UoKGFjYywgdmFsKSA9PiAodmFsLmxlbmd0aCA+IGFjYyA/IHZhbC5sZW5ndGggOiBhY2MpLCAwKTtcblxuXG4gIGxpbmVzLmZvckVhY2goKGxpbmUpID0+IHtcbiAgICBsZXQgc3BhY2VzO1xuICAgIGZvciAoc3BhY2VzID0gMDsgbGluZVtzcGFjZXNdID09PSAnICcgJiYgc3BhY2VzIDwgbGluZS5sZW5ndGg7IHNwYWNlcyArPSAxKTtcbiAgICBpZiAobWluU3BhY2VzID4gc3BhY2VzKSBtaW5TcGFjZXMgPSBzcGFjZXM7XG4gIH0pO1xuXG4gIGxpbmVzLmZvckVhY2goKF8sIGlkKSA9PiB7XG4gICAgY29uc3QgbGluZU51bSA9IFN0cmluZyhgMCR7c3RhcnRMaW5lIC0gYWN0dWFsTGluZXNCZWZvcmUgKyBpZH1gKS5zbGljZSgtbWF4TGluZU51bS50b1N0cmluZygpLmxlbmd0aCk7XG4gICAgY29uc3QgbGluZSA9IG1pblNwYWNlcyA+PSA0ID8gbGluZXNbaWRdLnNsaWNlKG1pblNwYWNlcykgOiBsaW5lc1tpZF07XG4gICAgaWYgKGlkIDw9IGFjdHVhbExpbmVzQmVmb3JlIC0gMSB8fCBpZCA+IGxpbmVzLmxlbmd0aCAtIGFjdHVhbExpbmVzQWZ0ZXIgLSAxKSB7XG4gICAgICBsaW5lc1tpZF0gPSBvdXRwdXRHcmV5KGAke2xpbmVOdW19fCAke2xpbmV9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxpbmVzW2lkXSA9IGAke291dHB1dEdyZXkoYCR7bGluZU51bX18YCl9JHtvdXRwdXRSZWQoYCAke2xpbmV9YCl9YDtcbiAgICB9XG4gIH0pO1xuXG4gIGNvZGVGcmFtZVN0cmluZyA9IGxpbmVzLmpvaW4oJ1xcbicpO1xuXG4gIHJldHVybiBjb2RlRnJhbWVTdHJpbmc7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBnZXRMb2NhdGlvbkJ5UGF0aDtcbiJdfQ==