"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.getCodeFrameForLocation = exports.getLocationByPathURI = exports.getLocationByPath = void 0;

var _yamlAstParser = require("yaml-ast-parser");

var _utils = require("../utils");

const parseAST = ctx => {
  if (ctx.AST) return ctx.AST;
  ctx.AST = (0, _yamlAstParser.safeLoad)(ctx.source);
  return ctx.AST;
};

const getMappingChild = (mapping, childName) => {
  const mappings = mapping.value ? mapping.value.mappings : mapping.mappings;
  const target = mappings.filter(child => child.key.value === childName);
  return target ? target[0] : null;
};

const getSequenceElement = (seq, id) => seq.value ? seq.value.items[id] : seq.items[id];

const getNodeByPath = (tree, path, target = 'value') => {
  if (path.length === 0) return target === 'value' ? tree : tree.key;
  const nextKey = path.pop();
  let next;

  if (tree.value && tree.value.mappings || tree.mappings) {
    next = getMappingChild(tree, nextKey);
  } else if (tree.value && tree.value.items || tree.items) {
    next = getSequenceElement(tree, nextKey);
  }

  return getNodeByPath(next, path, target);
};

const getLocationByPath = (path, ctx, target) => {
  const AST = parseAST(ctx);
  const node = getNodeByPath(AST, path.reverse(), target);
  if (!node) return null; // console.log(node);

  const positionStart = (0, _utils.getLineNumberFromId)(ctx.source, node.startPosition);
  const endPosition = (0, _utils.getLineNumberFromId)(ctx.source, node.endPosition);
  return {
    startLine: positionStart.lineNum,
    startCol: positionStart.posNum,
    endLine: endPosition.lineNum,
    endCol: endPosition.posNum,
    startIndex: node.startPosition,
    endIndex: node.endPosition
  };
};

exports.getLocationByPath = getLocationByPath;

const getLocationByPathURI = (path, ctx, target) => {
  const pathArray = path.replace('#/', '').split('/');
  return getLocationByPath(pathArray, ctx, target);
};

exports.getLocationByPathURI = getLocationByPathURI;

const getCodeFrameForLocation = (start, end, source, linesBefore = 3, linesAfter = 2) => {
  let frameStart = start;
  let frameEnd = end;
  let actualLinesBefore = -1;
  let actualLinesAfter = -1;

  for (; actualLinesBefore !== linesBefore && frameStart >= 0; frameStart -= 1) {
    if (source[frameStart - 1] === '\n') actualLinesBefore += 1;
  }

  while (actualLinesAfter !== linesAfter && frameEnd !== source.length) {
    if (source[frameEnd] === '\n') actualLinesAfter += 1;
    frameEnd += 1;
  }

  const codeFrame = source.substring(frameStart, frameEnd + 1);
  let startOffset = start - frameStart;
  const endOffset = startOffset + end - start;
  if (frameStart === -1) startOffset -= 1;
  return `${codeFrame.substring(0, startOffset)}${(0, _utils.outputUnderline)((0, _utils.outputRed)(codeFrame.substring(startOffset, endOffset)))}${codeFrame.substring(endOffset)}`;
};

exports.getCodeFrameForLocation = getCodeFrameForLocation;
var _default = getLocationByPath;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy95YW1sL2luZGV4LmpzIl0sIm5hbWVzIjpbInBhcnNlQVNUIiwiY3R4IiwiQVNUIiwic291cmNlIiwiZ2V0TWFwcGluZ0NoaWxkIiwibWFwcGluZyIsImNoaWxkTmFtZSIsIm1hcHBpbmdzIiwidmFsdWUiLCJ0YXJnZXQiLCJmaWx0ZXIiLCJjaGlsZCIsImtleSIsImdldFNlcXVlbmNlRWxlbWVudCIsInNlcSIsImlkIiwiaXRlbXMiLCJnZXROb2RlQnlQYXRoIiwidHJlZSIsInBhdGgiLCJsZW5ndGgiLCJuZXh0S2V5IiwicG9wIiwibmV4dCIsImdldExvY2F0aW9uQnlQYXRoIiwibm9kZSIsInJldmVyc2UiLCJwb3NpdGlvblN0YXJ0Iiwic3RhcnRQb3NpdGlvbiIsImVuZFBvc2l0aW9uIiwic3RhcnRMaW5lIiwibGluZU51bSIsInN0YXJ0Q29sIiwicG9zTnVtIiwiZW5kTGluZSIsImVuZENvbCIsInN0YXJ0SW5kZXgiLCJlbmRJbmRleCIsImdldExvY2F0aW9uQnlQYXRoVVJJIiwicGF0aEFycmF5IiwicmVwbGFjZSIsInNwbGl0IiwiZ2V0Q29kZUZyYW1lRm9yTG9jYXRpb24iLCJzdGFydCIsImVuZCIsImxpbmVzQmVmb3JlIiwibGluZXNBZnRlciIsImZyYW1lU3RhcnQiLCJmcmFtZUVuZCIsImFjdHVhbExpbmVzQmVmb3JlIiwiYWN0dWFsTGluZXNBZnRlciIsImNvZGVGcmFtZSIsInN1YnN0cmluZyIsInN0YXJ0T2Zmc2V0IiwiZW5kT2Zmc2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7O0FBRUEsTUFBTUEsUUFBUSxHQUFJQyxHQUFELElBQVM7QUFDeEIsTUFBSUEsR0FBRyxDQUFDQyxHQUFSLEVBQWEsT0FBT0QsR0FBRyxDQUFDQyxHQUFYO0FBQ2JELEVBQUFBLEdBQUcsQ0FBQ0MsR0FBSixHQUFVLDZCQUFTRCxHQUFHLENBQUNFLE1BQWIsQ0FBVjtBQUNBLFNBQU9GLEdBQUcsQ0FBQ0MsR0FBWDtBQUNELENB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O0FBQ0EsUUFBTU8sU0FBUyxHQUFHRCxXQUFXLEdBQUdULEdBQWQsR0FBb0JELEtBQXRDO0FBRUEsTUFBSUksVUFBVSxLQUFLLENBQUMsQ0FBcEIsRUFBdUJNLFdBQVcsSUFBSSxDQUFmO0FBRXZCLFNBQVEsR0FBRUYsU0FBUyxDQUFDQyxTQUFWLENBQW9CLENBQXBCLEVBQXVCQyxXQUF2QixDQUFvQyxHQUFFLDRCQUFnQixzQkFBVUYsU0FBUyxDQUFDQyxTQUFWLENBQW9CQyxXQUFwQixFQUFpQ0MsU0FBakMsQ0FBVixDQUFoQixDQUF3RSxHQUFFSCxTQUFTLENBQUNDLFNBQVYsQ0FBb0JFLFNBQXBCLENBQStCLEVBQXpKO0FBQ0QsQ0F0Qk07OztlQXdCUTlCLGlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2FmZUxvYWQgfSBmcm9tICd5YW1sLWFzdC1wYXJzZXInO1xuXG5pbXBvcnQgeyBvdXRwdXRSZWQsIG91dHB1dFVuZGVybGluZSwgZ2V0TGluZU51bWJlckZyb21JZCB9IGZyb20gJy4uL3V0aWxzJztcblxuY29uc3QgcGFyc2VBU1QgPSAoY3R4KSA9PiB7XG4gIGlmIChjdHguQVNUKSByZXR1cm4gY3R4LkFTVDtcbiAgY3R4LkFTVCA9IHNhZmVMb2FkKGN0eC5zb3VyY2UpO1xuICByZXR1cm4gY3R4LkFTVDtcbn07XG5cbmNvbnN0IGdldE1hcHBpbmdDaGlsZCA9IChtYXBwaW5nLCBjaGlsZE5hbWUpID0+IHtcbiAgY29uc3QgbWFwcGluZ3MgPSBtYXBwaW5nLnZhbHVlID8gbWFwcGluZy52YWx1ZS5tYXBwaW5ncyA6IG1hcHBpbmcubWFwcGluZ3M7XG4gIGNvbnN0IHRhcmdldCA9IG1hcHBpbmdzXG4gICAgLmZpbHRlcigoY2hpbGQpID0+IGNoaWxkLmtleS52YWx1ZSA9PT0gY2hpbGROYW1lKTtcbiAgcmV0dXJuIHRhcmdldCA/IHRhcmdldFswXSA6IG51bGw7XG59O1xuXG5jb25zdCBnZXRTZXF1ZW5jZUVsZW1lbnQgPSAoc2VxLCBpZCkgPT4gKHNlcS52YWx1ZSA/IHNlcS52YWx1ZS5pdGVtc1tpZF0gOiBzZXEuaXRlbXNbaWRdKTtcblxuY29uc3QgZ2V0Tm9kZUJ5UGF0aCA9ICh0cmVlLCBwYXRoLCB0YXJnZXQgPSAndmFsdWUnKSA9PiB7XG4gIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRhcmdldCA9PT0gJ3ZhbHVlJyA/IHRyZWUgOiB0cmVlLmtleTtcbiAgY29uc3QgbmV4dEtleSA9IHBhdGgucG9wKCk7XG4gIGxldCBuZXh0O1xuICBpZiAoKHRyZWUudmFsdWUgJiYgdHJlZS52YWx1ZS5tYXBwaW5ncykgfHwgdHJlZS5tYXBwaW5ncykge1xuICAgIG5leHQgPSBnZXRNYXBwaW5nQ2hpbGQodHJlZSwgbmV4dEtleSk7XG4gIH0gZWxzZSBpZiAoKHRyZWUudmFsdWUgJiYgdHJlZS52YWx1ZS5pdGVtcykgfHwgdHJlZS5pdGVtcykge1xuICAgIG5leHQgPSBnZXRTZXF1ZW5jZUVsZW1lbnQodHJlZSwgbmV4dEtleSk7XG4gIH1cbiAgcmV0dXJuIGdldE5vZGVCeVBhdGgobmV4dCwgcGF0aCwgdGFyZ2V0KTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRMb2NhdGlvbkJ5UGF0aCA9IChwYXRoLCBjdHgsIHRhcmdldCkgPT4ge1xuICBjb25zdCBBU1QgPSBwYXJzZUFTVChjdHgpO1xuICBjb25zdCBub2RlID0gZ2V0Tm9kZUJ5UGF0aChBU1QsIHBhdGgucmV2ZXJzZSgpLCB0YXJnZXQpO1xuICBpZiAoIW5vZGUpIHJldHVybiBudWxsO1xuICAvLyBjb25zb2xlLmxvZyhub2RlKTtcbiAgY29uc3QgcG9zaXRpb25TdGFydCA9IGdldExpbmVOdW1iZXJGcm9tSWQoY3R4LnNvdXJjZSwgbm9kZS5zdGFydFBvc2l0aW9uKTtcbiAgY29uc3QgZW5kUG9zaXRpb24gPSBnZXRMaW5lTnVtYmVyRnJvbUlkKGN0eC5zb3VyY2UsIG5vZGUuZW5kUG9zaXRpb24pO1xuICByZXR1cm4ge1xuICAgIHN0YXJ0TGluZTogcG9zaXRpb25TdGFydC5saW5lTnVtLFxuICAgIHN0YXJ0Q29sOiBwb3NpdGlvblN0YXJ0LnBvc051bSxcbiAgICBlbmRMaW5lOiBlbmRQb3NpdGlvbi5saW5lTnVtLFxuICAgIGVuZENvbDogZW5kUG9zaXRpb24ucG9zTnVtLFxuICAgIHN0YXJ0SW5kZXg6IG5vZGUuc3RhcnRQb3NpdGlvbixcbiAgICBlbmRJbmRleDogbm9kZS5lbmRQb3NpdGlvbixcbiAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRMb2NhdGlvbkJ5UGF0aFVSSSA9IChwYXRoLCBjdHgsIHRhcmdldCkgPT4ge1xuICBjb25zdCBwYXRoQXJyYXkgPSBwYXRoLnJlcGxhY2UoJyMvJywgJycpLnNwbGl0KCcvJyk7XG4gIHJldHVybiBnZXRMb2NhdGlvbkJ5UGF0aChwYXRoQXJyYXksIGN0eCwgdGFyZ2V0KTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRDb2RlRnJhbWVGb3JMb2NhdGlvbiA9IChzdGFydCwgZW5kLCBzb3VyY2UsIGxpbmVzQmVmb3JlID0gMywgbGluZXNBZnRlciA9IDIpID0+IHtcbiAgbGV0IGZyYW1lU3RhcnQgPSBzdGFydDtcbiAgbGV0IGZyYW1lRW5kID0gZW5kO1xuICBsZXQgYWN0dWFsTGluZXNCZWZvcmUgPSAtMTtcbiAgbGV0IGFjdHVhbExpbmVzQWZ0ZXIgPSAtMTtcblxuICBmb3IgKDsgYWN0dWFsTGluZXNCZWZvcmUgIT09IGxpbmVzQmVmb3JlICYmIGZyYW1lU3RhcnQgPj0gMDsgZnJhbWVTdGFydCAtPSAxKSB7XG4gICAgaWYgKHNvdXJjZVtmcmFtZVN0YXJ0IC0gMV0gPT09ICdcXG4nKSBhY3R1YWxMaW5lc0JlZm9yZSArPSAxO1xuICB9XG5cbiAgd2hpbGUgKGFjdHVhbExpbmVzQWZ0ZXIgIT09IGxpbmVzQWZ0ZXIgJiYgZnJhbWVFbmQgIT09IHNvdXJjZS5sZW5ndGgpIHtcbiAgICBpZiAoc291cmNlW2ZyYW1lRW5kXSA9PT0gJ1xcbicpIGFjdHVhbExpbmVzQWZ0ZXIgKz0gMTtcbiAgICBmcmFtZUVuZCArPSAxO1xuICB9XG5cbiAgY29uc3QgY29kZUZyYW1lID0gc291cmNlLnN1YnN0cmluZyhmcmFtZVN0YXJ0LCBmcmFtZUVuZCArIDEpO1xuICBsZXQgc3RhcnRPZmZzZXQgPSBzdGFydCAtIGZyYW1lU3RhcnQ7XG4gIGNvbnN0IGVuZE9mZnNldCA9IHN0YXJ0T2Zmc2V0ICsgZW5kIC0gc3RhcnQ7XG5cbiAgaWYgKGZyYW1lU3RhcnQgPT09IC0xKSBzdGFydE9mZnNldCAtPSAxO1xuXG4gIHJldHVybiBgJHtjb2RlRnJhbWUuc3Vic3RyaW5nKDAsIHN0YXJ0T2Zmc2V0KX0ke291dHB1dFVuZGVybGluZShvdXRwdXRSZWQoY29kZUZyYW1lLnN1YnN0cmluZyhzdGFydE9mZnNldCwgZW5kT2Zmc2V0KSkpfSR7Y29kZUZyYW1lLnN1YnN0cmluZyhlbmRPZmZzZXQpfWA7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBnZXRMb2NhdGlvbkJ5UGF0aDtcbiJdfQ==