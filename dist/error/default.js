"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _yaml = require("../yaml");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const prettyPrintError = (error, enableCodeframe) => {
  const message = `${(0, _utils.outputBgRed)(`${error.file}:${error.location.startLine}:${error.location.startCol}`)}` + ` ${(0, _utils.outputGrey)(`at ${error.path}`)}` + `\n${error.message}\n` + `\nat ${(0, _utils.outputLightBlue)(`${error.file}:${error.location.startLine}:${error.location.startCol}`)} ${(0, _utils.outputGrey)(`at ${error.path}`)}` + `${error.pathStack.length ? `\nat ${error.pathStack.reverse().join('\nat ')}\n` : '\n'}` + `${enableCodeframe ? `\n${error.codeFrame}\n` : ''}`;
  return message;
};

const pathImproveReadability = path => path.map(el => el[0] === '/' ? (0, _utils.outputGrey)('[\'') + (0, _utils.outputLightBlue)(el) + (0, _utils.outputGrey)('\']') : el);

const getLocationForPath = (fName, path, target) => {
  const fContent = _fs.default.readFileSync(fName, 'utf-8');

  const tempCtx = {
    source: fContent
  };
  const location = (0, _yaml.getLocationByPath)(Array.from(path), tempCtx, target);
  return location.startLine;
};

const createError = (msg, node, ctx, target) => {
  let location = (0, _yaml.getLocationByPath)(Array.from(ctx.path), ctx, target);
  if (!location) location = (0, _yaml.getLocationByPath)(Array.from(ctx.path), ctx);
  const body = {
    message: msg,
    path: pathImproveReadability(ctx.path).join('/'),
    pathStack: ctx.pathStack.map(el => {
      const startLine = getLocationForPath(el.file, el.path, target);
      return `${(0, _utils.outputLightBlue)(`${el.file}:${startLine}`)} ${(0, _utils.outputGrey)(`#/${el.path.join('/')}`)}`;
    }),
    location,
    codeFrame: ctx.enableCodeframe && location ? (0, _yaml.getCodeFrameForLocation)(location.startIndex, location.endIndex, ctx.source, location.startLine) : null,
    value: node,
    file: ctx.filePath,
    severity: 'ERROR'
  };
  return { ...body,
    prettyPrint: () => prettyPrintError(body, ctx.enableCodeframe)
  };
};

var _default = createError;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lcnJvci9kZWZhdWx0LmpzIl0sIm5hbWVzIjpbInByZXR0eVByaW50RXJyb3IiLCJlcnJvciIsImVuYWJsZUNvZGVmcmFtZSIsIm1lc3NhZ2UiLCJmaWxlIiwibG9jYXRpb24iLCJzdGFydExpbmUiLCJzdGFydENvbCIsInBhdGgiLCJwYXRoU3RhY2siLCJsZW5ndGgiLCJyZXZlcnNlIiwiam9pbiIsImNvZGVGcmFtZSIsInBhdGhJbXByb3ZlUmVhZGFiaWxpdHkiLCJtYXAiLCJlbCIsImdldExvY2F0aW9uRm9yUGF0aCIsImZOYW1lIiwidGFyZ2V0IiwiZkNvbnRlbnQiLCJmcyIsInJlYWRGaWxlU3luYyIsInRlbXBDdHgiLCJzb3VyY2UiLCJBcnJheSIsImZyb20iLCJjcmVhdGVFcnJvciIsIm1zZyIsIm5vZGUiLCJjdHgiLCJib2R5Iiwic3RhcnRJbmRleCIsImVuZEluZGV4IiwidmFsdWUiLCJmaWxlUGF0aCIsInNldmVyaXR5IiwicHJldHR5UHJpbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLGdCQUFnQixHQUFHLENBQUNDLEtBQUQsRUFBUUMsZUFBUixLQUE0QjtBQUNuRCxRQUFNQyxPQUFPLEdBQUksR0FBRSx3QkFBYSxHQUFFRixLQUFLLENBQUNHLElBQUssSUFBR0gsS0FBSyxDQUFDSSxRQUFOLENBQWVDLFNBQVUsSUFBR0wsS0FBSyxDQUFDSSxRQUFOLENBQWVFLFFBQVMsRUFBakYsQ0FBb0YsRUFBdkYsR0FDYixJQUFHLHVCQUFZLE1BQUtOLEtBQUssQ0FBQ08sSUFBSyxFQUE1QixDQUErQixFQURyQixHQUViLEtBQUlQLEtBQUssQ0FBQ0UsT0FBUSxJQUZMLEdBR2IsUUFBTyw0QkFBaUIsR0FBRUYsS0FBSyxDQUFDRyxJQUFLLElBQUdILEtBQUssQ0FBQ0ksUUFBTixDQUFlQyxTQUFVLElBQUdMLEtBQUssQ0FBQ0ksUUFBTixDQUFlRSxRQUFTLEVBQXJGLENBQXdGLElB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SUFBQUEsUUFBUSxFQUFFO0FBbEJDLEdBQWI7QUFvQkEsU0FBTyxFQUNMLEdBQUdMLElBREU7QUFFTE0sSUFBQUEsV0FBVyxFQUFFLE1BQU1yQyxnQkFBZ0IsQ0FBQytCLElBQUQsRUFBT0QsR0FBRyxDQUFDNUIsZUFBWDtBQUY5QixHQUFQO0FBSUQsQ0EzQkQ7O2VBNkJleUIsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBnZXRMb2NhdGlvbkJ5UGF0aCwgZ2V0Q29kZUZyYW1lRm9yTG9jYXRpb24gfSBmcm9tICcuLi95YW1sJztcbmltcG9ydCB7IG91dHB1dExpZ2h0Qmx1ZSwgb3V0cHV0QmdSZWQsIG91dHB1dEdyZXkgfSBmcm9tICcuLi91dGlscyc7XG5cbmNvbnN0IHByZXR0eVByaW50RXJyb3IgPSAoZXJyb3IsIGVuYWJsZUNvZGVmcmFtZSkgPT4ge1xuICBjb25zdCBtZXNzYWdlID0gYCR7b3V0cHV0QmdSZWQoYCR7ZXJyb3IuZmlsZX06JHtlcnJvci5sb2NhdGlvbi5zdGFydExpbmV9OiR7ZXJyb3IubG9jYXRpb24uc3RhcnRDb2x9YCl9YFxuICArIGAgJHtvdXRwdXRHcmV5KGBhdCAke2Vycm9yLnBhdGh9YCl9YFxuICArIGBcXG4ke2Vycm9yLm1lc3NhZ2V9XFxuYFxuICArIGBcXG5hdCAke291dHB1dExpZ2h0Qmx1ZShgJHtlcnJvci5maWxlfToke2Vycm9yLmxvY2F0aW9uLnN0YXJ0TGluZX06JHtlcnJvci5sb2NhdGlvbi5zdGFydENvbH1gKX0gJHtvdXRwdXRHcmV5KGBhdCAke2Vycm9yLnBhdGh9YCl9YFxuICArIGAke2Vycm9yLnBhdGhTdGFjay5sZW5ndGggPyBgXFxuYXQgJHtlcnJvci5wYXRoU3RhY2sucmV2ZXJzZSgpLmpvaW4oJ1xcbmF0ICcpfVxcbmAgOiAnXFxuJ31gXG4gICsgYCR7ZW5hYmxlQ29kZWZyYW1lID8gYFxcbiR7ZXJyb3IuY29kZUZyYW1lfVxcbmAgOiAnJ31gO1xuICByZXR1cm4gbWVzc2FnZTtcbn07XG5cbmNvbnN0IHBhdGhJbXByb3ZlUmVhZGFiaWxpdHkgPSAocGF0aCkgPT4gcGF0aC5tYXAoKGVsKSA9PiAoZWxbMF0gPT09ICcvJyA/IG91dHB1dEdyZXkoJ1tcXCcnKSArIG91dHB1dExpZ2h0Qmx1ZShlbCkgKyBvdXRwdXRHcmV5KCdcXCddJykgOiBlbCkpO1xuXG5jb25zdCBnZXRMb2NhdGlvbkZvclBhdGggPSAoZk5hbWUsIHBhdGgsIHRhcmdldCkgPT4ge1xuICBjb25zdCBmQ29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhmTmFtZSwgJ3V0Zi04Jyk7XG4gIGNvbnN0IHRlbXBDdHggPSB7IHNvdXJjZTogZkNvbnRlbnQgfTtcbiAgY29uc3QgbG9jYXRpb24gPSBnZXRMb2NhdGlvbkJ5UGF0aChBcnJheS5mcm9tKHBhdGgpLCB0ZW1wQ3R4LCB0YXJnZXQpO1xuICByZXR1cm4gbG9jYXRpb24uc3RhcnRMaW5lO1xufTtcblxuY29uc3QgY3JlYXRlRXJyb3IgPSAobXNnLCBub2RlLCBjdHgsIHRhcmdldCkgPT4ge1xuICBsZXQgbG9jYXRpb24gPSBnZXRMb2NhdGlvbkJ5UGF0aChBcnJheS5mcm9tKGN0eC5wYXRoKSwgY3R4LCB0YXJnZXQpO1xuICBpZiAoIWxvY2F0aW9uKSBsb2NhdGlvbiA9IGdldExvY2F0aW9uQnlQYXRoKEFycmF5LmZyb20oY3R4LnBhdGgpLCBjdHgpO1xuICBjb25zdCBib2R5ID0ge1xuICAgIG1lc3NhZ2U6IG1zZyxcbiAgICBwYXRoOiBwYXRoSW1wcm92ZVJlYWRhYmlsaXR5KGN0eC5wYXRoKS5qb2luKCcvJyksXG4gICAgcGF0aFN0YWNrOiBjdHgucGF0aFN0YWNrLm1hcCgoZWwpID0+IHtcbiAgICAgIGNvbnN0IHN0YXJ0TGluZSA9IGdldExvY2F0aW9uRm9yUGF0aChlbC5maWxlLCBlbC5wYXRoLCB0YXJnZXQpO1xuICAgICAgcmV0dXJuIGAke291dHB1dExpZ2h0Qmx1ZShgJHtlbC5maWxlfToke3N0YXJ0TGluZX1gKX0gJHtvdXRwdXRHcmV5KGAjLyR7ZWwucGF0aC5qb2luKCcvJyl9YCl9YDtcbiAgICB9KSxcbiAgICBsb2NhdGlvbixcbiAgICBjb2RlRnJhbWU6IGN0eC5lbmFibGVDb2RlZnJhbWUgJiYgbG9jYXRpb25cbiAgICAgID8gZ2V0Q29kZUZyYW1lRm9yTG9jYXRpb24oXG4gICAgICAgIGxvY2F0aW9uLnN0YXJ0SW5kZXgsXG4gICAgICAgIGxvY2F0aW9uLmVuZEluZGV4LFxuICAgICAgICBjdHguc291cmNlLFxuICAgICAgICBsb2NhdGlvbi5zdGFydExpbmUsXG4gICAgICApXG4gICAgICA6IG51bGwsXG4gICAgdmFsdWU6IG5vZGUsXG4gICAgZmlsZTogY3R4LmZpbGVQYXRoLFxuICAgIHNldmVyaXR5OiAnRVJST1InLFxuICB9O1xuICByZXR1cm4ge1xuICAgIC4uLmJvZHksXG4gICAgcHJldHR5UHJpbnQ6ICgpID0+IHByZXR0eVByaW50RXJyb3IoYm9keSwgY3R4LmVuYWJsZUNvZGVmcmFtZSksXG4gIH07XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVFcnJvcjtcbiJdfQ==